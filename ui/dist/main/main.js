"use strict";const electron=require("electron"),require$$1=require("path"),promises=require("fs/promises"),require$$0=require("fs"),require$$1$2=require("util"),require$$2$1=require("events"),require$$0$1=require("child_process"),require$$1$1=require("os"),require$$2=require("stream");var commonjsGlobal=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function getDefaultExportFromCjs(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}var utils$2={exports:{}},windows,hasRequiredWindows;function requireWindows(){if(hasRequiredWindows)return windows;hasRequiredWindows=1,windows=i,i.sync=p;var n=require$$0;function e(o,f){var a=f.pathExt!==void 0?f.pathExt:process.env.PATHEXT;if(!a||(a=a.split(";"),a.indexOf("")!==-1))return!0;for(var d=0;d<a.length;d++){var y=a[d].toLowerCase();if(y&&o.substr(-y.length).toLowerCase()===y)return!0}return!1}function t(o,f,a){return!o.isSymbolicLink()&&!o.isFile()?!1:e(f,a)}function i(o,f,a){n.stat(o,function(d,y){a(d,d?!1:t(y,o,f))})}function p(o,f){return t(n.statSync(o),o,f)}return windows}var mode,hasRequiredMode;function requireMode(){if(hasRequiredMode)return mode;hasRequiredMode=1,mode=e,e.sync=t;var n=require$$0;function e(o,f,a){n.stat(o,function(d,y){a(d,d?!1:i(y,f))})}function t(o,f){return i(n.statSync(o),f)}function i(o,f){return o.isFile()&&p(o,f)}function p(o,f){var a=o.mode,d=o.uid,y=o.gid,g=f.uid!==void 0?f.uid:process.getuid&&process.getuid(),P=f.gid!==void 0?f.gid:process.getgid&&process.getgid(),v=parseInt("100",8),A=parseInt("010",8),x=parseInt("001",8),q=v|A,w=a&x||a&A&&y===P||a&v&&d===g||a&q&&g===0;return w}return mode}var core;process.platform==="win32"||commonjsGlobal.TESTING_WINDOWS?core=requireWindows():core=requireMode();var isexe_1=isexe$1;isexe$1.sync=sync;function isexe$1(n,e,t){if(typeof e=="function"&&(t=e,e={}),!t){if(typeof Promise!="function")throw new TypeError("callback not provided");return new Promise(function(i,p){isexe$1(n,e||{},function(o,f){o?p(o):i(f)})})}core(n,e||{},function(i,p){i&&(i.code==="EACCES"||e&&e.ignoreErrors)&&(i=null,p=!1),t(i,p)})}function sync(n,e){try{return core.sync(n,e||{})}catch(t){if(e&&e.ignoreErrors||t.code==="EACCES")return!1;throw t}}var which_1=which$1;which$1.sync=whichSync;var isWindows$1=process.platform==="win32"||process.env.OSTYPE==="cygwin"||process.env.OSTYPE==="msys",path$1=require$$1,COLON=isWindows$1?";":":",isexe=isexe_1;function getNotFoundError(n){var e=new Error("not found: "+n);return e.code="ENOENT",e}function getPathInfo(n,e){var t=e.colon||COLON,i=e.path||process.env.PATH||"",p=[""];i=i.split(t);var o="";return isWindows$1&&(i.unshift(process.cwd()),o=e.pathExt||process.env.PATHEXT||".EXE;.CMD;.BAT;.COM",p=o.split(t),n.indexOf(".")!==-1&&p[0]!==""&&p.unshift("")),(n.match(/\//)||isWindows$1&&n.match(/\\/))&&(i=[""]),{env:i,ext:p,extExe:o}}function which$1(n,e,t){typeof e=="function"&&(t=e,e={});var i=getPathInfo(n,e),p=i.env,o=i.ext,f=i.extExe,a=[];(function d(y,g){if(y===g)return e.all&&a.length?t(null,a):t(getNotFoundError(n));var P=p[y];P.charAt(0)==='"'&&P.slice(-1)==='"'&&(P=P.slice(1,-1));var v=path$1.join(P,n);!P&&/^\.[\\\/]/.test(n)&&(v=n.slice(0,2)+v),function A(x,q){if(x===q)return d(y+1,g);var w=o[x];isexe(v+w,{pathExt:f},function(C,b){if(!C&&b)if(e.all)a.push(v+w);else return t(null,v+w);return A(x+1,q)})}(0,o.length)})(0,p.length)}function whichSync(n,e){e=e||{};for(var t=getPathInfo(n,e),i=t.env,p=t.ext,o=t.extExe,f=[],a=0,d=i.length;a<d;a++){var y=i[a];y.charAt(0)==='"'&&y.slice(-1)==='"'&&(y=y.slice(1,-1));var g=path$1.join(y,n);!y&&/^\.[\\\/]/.test(n)&&(g=n.slice(0,2)+g);for(var P=0,v=p.length;P<v;P++){var A=g+p[P],x;try{if(x=isexe.sync(A,{pathExt:o}),x)if(e.all)f.push(A);else return A}catch{}}}if(e.all&&f.length)return f;if(e.nothrow)return null;throw getNotFoundError(n)}require$$0$1.exec;var isWindows=require$$1$1.platform().match(/win(32|64)/),which=which_1,nlRegexp=/\r\n|\r|\n/g,streamRegexp=/^\[?(.*?)\]?$/,filterEscapeRegexp=/[,]/,whichCache={};function parseProgressLine(n){var e={};n=n.replace(/=\s+/g,"=").trim();for(var t=n.split(" "),i=0;i<t.length;i++){var p=t[i].split("=",2),o=p[0],f=p[1];if(typeof f>"u")return null;e[o]=f}return e}var utils$1=utils$2.exports={isWindows,streamRegexp,copy:function(n,e){Object.keys(n).forEach(function(t){e[t]=n[t]})},args:function(){var n=[],e=function(){arguments.length===1&&Array.isArray(arguments[0])?n=n.concat(arguments[0]):n=n.concat([].slice.call(arguments))};return e.clear=function(){n=[]},e.get=function(){return n},e.find=function(t,i){var p=n.indexOf(t);if(p!==-1)return n.slice(p+1,p+1+(i||0))},e.remove=function(t,i){var p=n.indexOf(t);p!==-1&&n.splice(p,(i||0)+1)},e.clone=function(){var t=utils$1.args();return t(n),t},e},makeFilterStrings:function(n){return n.map(function(e){if(typeof e=="string")return e;var t="";return Array.isArray(e.inputs)?t+=e.inputs.map(function(i){return i.replace(streamRegexp,"[$1]")}).join(""):typeof e.inputs=="string"&&(t+=e.inputs.replace(streamRegexp,"[$1]")),t+=e.filter,e.options&&(typeof e.options=="string"||typeof e.options=="number"?t+="="+e.options:Array.isArray(e.options)?t+="="+e.options.map(function(i){return typeof i=="string"&&i.match(filterEscapeRegexp)?"'"+i+"'":i}).join(":"):Object.keys(e.options).length&&(t+="="+Object.keys(e.options).map(function(i){var p=e.options[i];return typeof p=="string"&&p.match(filterEscapeRegexp)&&(p="'"+p+"'"),i+"="+p}).join(":"))),Array.isArray(e.outputs)?t+=e.outputs.map(function(i){return i.replace(streamRegexp,"[$1]")}).join(""):typeof e.outputs=="string"&&(t+=e.outputs.replace(streamRegexp,"[$1]")),t})},which:function(n,e){if(n in whichCache)return e(null,whichCache[n]);which(n,function(t,i){if(t)return e(null,whichCache[n]="");e(null,whichCache[n]=i)})},timemarkToSeconds:function(n){if(typeof n=="number")return n;if(n.indexOf(":")===-1&&n.indexOf(".")>=0)return Number(n);var e=n.split(":"),t=Number(e.pop());return e.length&&(t+=Number(e.pop())*60),e.length&&(t+=Number(e.pop())*3600),t},extractCodecData:function(n,e,t){var i=/Input #[0-9]+, ([^ ]+),/,p=/Duration\: ([^,]+)/,o=/Audio\: (.*)/,f=/Video\: (.*)/;"inputStack"in t||(t.inputStack=[],t.inputIndex=-1,t.inInput=!1);var a=t.inputStack,d=t.inputIndex,y=t.inInput,g,P,v,A;if(g=e.match(i))y=t.inInput=!0,d=t.inputIndex=t.inputIndex+1,a[d]={format:g[1],audio:"",video:"",duration:""};else if(y&&(P=e.match(p)))a[d].duration=P[1];else if(y&&(v=e.match(o)))v=v[1].split(", "),a[d].audio=v[0],a[d].audio_details=v;else if(y&&(A=e.match(f)))A=A[1].split(", "),a[d].video=A[0],a[d].video_details=A;else if(/Output #\d+/.test(e))y=t.inInput=!1;else if(/Stream mapping:|Press (\[q\]|ctrl-c) to stop/.test(e))return n.emit.apply(n,["codecData"].concat(a)),!0;return!1},extractProgress:function(n,e){var t=parseProgressLine(e);if(t){var i={frames:parseInt(t.frame,10),currentFps:parseInt(t.fps,10),currentKbps:t.bitrate?parseFloat(t.bitrate.replace("kbits/s","")):0,targetSize:parseInt(t.size||t.Lsize,10),timemark:t.time};if(n._ffprobeData&&n._ffprobeData.format&&n._ffprobeData.format.duration){var p=Number(n._ffprobeData.format.duration);isNaN(p)||(i.percent=utils$1.timemarkToSeconds(i.timemark)/p*100)}n.emit("progress",i)}},extractError:function(n){return n.split(nlRegexp).reduce(function(e,t){return t.charAt(0)===" "||t.charAt(0)==="["?[]:(e.push(t),e)},[]).join(`
`)},linesRing:function(n){var e=[],t=[],i=null,p=!1,o=n-1;function f(a){e.forEach(function(d){d(a)})}return{callback:function(a){t.forEach(function(d){a(d)}),e.push(a)},append:function(a){if(!p&&(a instanceof Buffer&&(a=""+a),!(!a||a.length===0))){var d=a.split(nlRegexp);d.length===1?i!==null?i=i+d.shift():i=d.shift():(i!==null&&(i=i+d.shift(),f(i),t.push(i)),i=d.pop(),d.forEach(function(y){f(y),t.push(y)}),o>-1&&t.length>o&&t.splice(0,t.length-o))}},get:function(){return i!==null?t.concat([i]).join(`
`):t.join(`
`)},close:function(){p||(i!==null&&(f(i),t.push(i),o>-1&&t.length>o&&t.shift(),i=null),p=!0)}}}},utilsExports=utils$2.exports,inputs,hasRequiredInputs;function requireInputs(){if(hasRequiredInputs)return inputs;hasRequiredInputs=1;var n=utilsExports;return inputs=function(e){e.mergeAdd=e.addInput=e.input=function(t){var i=!1,p=!1;if(typeof t!="string"){if(!("readable"in t)||!t.readable)throw new Error("Invalid input");var o=this._inputs.some(function(a){return a.isStream});if(o)throw new Error("Only one input stream is supported");p=!0,t.pause()}else{var f=t.match(/^([a-z]{2,}):/i);i=!f||f[0]==="file"}return this._inputs.push(this._currentInput={source:t,isFile:i,isStream:p,options:n.args()}),this},e.withInputFormat=e.inputFormat=e.fromFormat=function(t){if(!this._currentInput)throw new Error("No input specified");return this._currentInput.options("-f",t),this},e.withInputFps=e.withInputFPS=e.withFpsInput=e.withFPSInput=e.inputFPS=e.inputFps=e.fpsInput=e.FPSInput=function(t){if(!this._currentInput)throw new Error("No input specified");return this._currentInput.options("-r",t),this},e.nativeFramerate=e.withNativeFramerate=e.native=function(){if(!this._currentInput)throw new Error("No input specified");return this._currentInput.options("-re"),this},e.setStartTime=e.seekInput=function(t){if(!this._currentInput)throw new Error("No input specified");return this._currentInput.options("-ss",t),this},e.loop=function(t){if(!this._currentInput)throw new Error("No input specified");return this._currentInput.options("-loop","1"),typeof t<"u"&&this.duration(t),this}},inputs}var audio,hasRequiredAudio;function requireAudio(){if(hasRequiredAudio)return audio;hasRequiredAudio=1;var n=utilsExports;return audio=function(e){e.withNoAudio=e.noAudio=function(){return this._currentOutput.audio.clear(),this._currentOutput.audioFilters.clear(),this._currentOutput.audio("-an"),this},e.withAudioCodec=e.audioCodec=function(t){return this._currentOutput.audio("-acodec",t),this},e.withAudioBitrate=e.audioBitrate=function(t){return this._currentOutput.audio("-b:a",(""+t).replace(/k?$/,"k")),this},e.withAudioChannels=e.audioChannels=function(t){return this._currentOutput.audio("-ac",t),this},e.withAudioFrequency=e.audioFrequency=function(t){return this._currentOutput.audio("-ar",t),this},e.withAudioQuality=e.audioQuality=function(t){return this._currentOutput.audio("-aq",t),this},e.withAudioFilter=e.withAudioFilters=e.audioFilter=e.audioFilters=function(t){return arguments.length>1&&(t=[].slice.call(arguments)),Array.isArray(t)||(t=[t]),this._currentOutput.audioFilters(n.makeFilterStrings(t)),this}},audio}var video,hasRequiredVideo;function requireVideo(){if(hasRequiredVideo)return video;hasRequiredVideo=1;var n=utilsExports;return video=function(e){e.withNoVideo=e.noVideo=function(){return this._currentOutput.video.clear(),this._currentOutput.videoFilters.clear(),this._currentOutput.video("-vn"),this},e.withVideoCodec=e.videoCodec=function(t){return this._currentOutput.video("-vcodec",t),this},e.withVideoBitrate=e.videoBitrate=function(t,i){return t=(""+t).replace(/k?$/,"k"),this._currentOutput.video("-b:v",t),i&&this._currentOutput.video("-maxrate",t,"-minrate",t,"-bufsize","3M"),this},e.withVideoFilter=e.withVideoFilters=e.videoFilter=e.videoFilters=function(t){return arguments.length>1&&(t=[].slice.call(arguments)),Array.isArray(t)||(t=[t]),this._currentOutput.videoFilters(n.makeFilterStrings(t)),this},e.withOutputFps=e.withOutputFPS=e.withFpsOutput=e.withFPSOutput=e.withFps=e.withFPS=e.outputFPS=e.outputFps=e.fpsOutput=e.FPSOutput=e.fps=e.FPS=function(t){return this._currentOutput.video("-r",t),this},e.takeFrames=e.withFrames=e.frames=function(t){return this._currentOutput.video("-vframes",t),this}},video}var videosize,hasRequiredVideosize;function requireVideosize(){if(hasRequiredVideosize)return videosize;hasRequiredVideosize=1;function n(t,i,p,o){return[{filter:"scale",options:{w:"if(gt(a,"+p+"),"+t+",trunc("+i+"*a/2)*2)",h:"if(lt(a,"+p+"),"+i+",trunc("+t+"/a/2)*2)"}},{filter:"pad",options:{w:t,h:i,x:"if(gt(a,"+p+"),0,("+t+"-iw)/2)",y:"if(lt(a,"+p+"),0,("+i+"-ih)/2)",color:o}}]}function e(t,i,p){var o=t.sizeData=t.sizeData||{};if(o[i]=p,!("size"in o))return[];var f=o.size.match(/([0-9]+)x([0-9]+)/),a=o.size.match(/([0-9]+)x\?/),d=o.size.match(/\?x([0-9]+)/),y=o.size.match(/\b([0-9]{1,3})%/),g,P,v;if(y){var A=Number(y[1])/100;return[{filter:"scale",options:{w:"trunc(iw*"+A+"/2)*2",h:"trunc(ih*"+A+"/2)*2"}}]}else{if(f)return g=Math.round(Number(f[1])/2)*2,P=Math.round(Number(f[2])/2)*2,v=g/P,o.pad?n(g,P,v,o.pad):[{filter:"scale",options:{w:g,h:P}}];if(a||d)return"aspect"in o?(g=a?a[1]:Math.round(Number(d[1])*o.aspect),P=d?d[1]:Math.round(Number(a[1])/o.aspect),g=Math.round(g/2)*2,P=Math.round(P/2)*2,o.pad?n(g,P,o.aspect,o.pad):[{filter:"scale",options:{w:g,h:P}}]):a?[{filter:"scale",options:{w:Math.round(Number(a[1])/2)*2,h:"trunc(ow/a/2)*2"}}]:[{filter:"scale",options:{w:"trunc(oh*a/2)*2",h:Math.round(Number(d[1])/2)*2}}];throw new Error("Invalid size specified: "+o.size)}}return videosize=function(t){t.keepPixelAspect=t.keepDisplayAspect=t.keepDisplayAspectRatio=t.keepDAR=function(){return this.videoFilters([{filter:"scale",options:{w:"if(gt(sar,1),iw*sar,iw)",h:"if(lt(sar,1),ih/sar,ih)"}},{filter:"setsar",options:"1"}])},t.withSize=t.setSize=t.size=function(i){var p=e(this._currentOutput,"size",i);return this._currentOutput.sizeFilters.clear(),this._currentOutput.sizeFilters(p),this},t.withAspect=t.withAspectRatio=t.setAspect=t.setAspectRatio=t.aspect=t.aspectRatio=function(i){var p=Number(i);if(isNaN(p)){var o=i.match(/^(\d+):(\d+)$/);if(o)p=Number(o[1])/Number(o[2]);else throw new Error("Invalid aspect ratio: "+i)}var f=e(this._currentOutput,"aspect",p);return this._currentOutput.sizeFilters.clear(),this._currentOutput.sizeFilters(f),this},t.applyAutopadding=t.applyAutoPadding=t.applyAutopad=t.applyAutoPad=t.withAutopadding=t.withAutoPadding=t.withAutopad=t.withAutoPad=t.autoPad=t.autopad=function(i,p){typeof i=="string"&&(p=i,i=!0),typeof i>"u"&&(i=!0);var o=e(this._currentOutput,"pad",i?p||"black":!1);return this._currentOutput.sizeFilters.clear(),this._currentOutput.sizeFilters(o),this}},videosize}var output,hasRequiredOutput;function requireOutput(){if(hasRequiredOutput)return output;hasRequiredOutput=1;var n=utilsExports;return output=function(e){e.addOutput=e.output=function(t,i){var p=!1;if(!t&&this._currentOutput)throw new Error("Invalid output");if(t&&typeof t!="string"){if(!("writable"in t)||!t.writable)throw new Error("Invalid output")}else if(typeof t=="string"){var o=t.match(/^([a-z]{2,}):/i);p=!o||o[0]==="file"}if(t&&!("target"in this._currentOutput))this._currentOutput.target=t,this._currentOutput.isFile=p,this._currentOutput.pipeopts=i||{};else{if(t&&typeof t!="string"){var f=this._outputs.some(function(d){return typeof d.target!="string"});if(f)throw new Error("Only one output stream is supported")}this._outputs.push(this._currentOutput={target:t,isFile:p,flags:{},pipeopts:i||{}});var a=this;["audio","audioFilters","video","videoFilters","sizeFilters","options"].forEach(function(d){a._currentOutput[d]=n.args()}),t||delete this._currentOutput.target}return this},e.seekOutput=e.seek=function(t){return this._currentOutput.options("-ss",t),this},e.withDuration=e.setDuration=e.duration=function(t){return this._currentOutput.options("-t",t),this},e.toFormat=e.withOutputFormat=e.outputFormat=e.format=function(t){return this._currentOutput.options("-f",t),this},e.map=function(t){return this._currentOutput.options("-map",t.replace(n.streamRegexp,"[$1]")),this},e.updateFlvMetadata=e.flvmeta=function(){return this._currentOutput.flags.flvmeta=!0,this}},output}var custom,hasRequiredCustom;function requireCustom(){if(hasRequiredCustom)return custom;hasRequiredCustom=1;var n=utilsExports;return custom=function(e){e.addInputOption=e.addInputOptions=e.withInputOption=e.withInputOptions=e.inputOption=e.inputOptions=function(t){if(!this._currentInput)throw new Error("No input specified");var i=!0;return arguments.length>1&&(t=[].slice.call(arguments),i=!1),Array.isArray(t)||(t=[t]),this._currentInput.options(t.reduce(function(p,o){var f=String(o).split(" ");return i&&f.length===2?p.push(f[0],f[1]):p.push(o),p},[])),this},e.addOutputOption=e.addOutputOptions=e.addOption=e.addOptions=e.withOutputOption=e.withOutputOptions=e.withOption=e.withOptions=e.outputOption=e.outputOptions=function(t){var i=!0;return arguments.length>1&&(t=[].slice.call(arguments),i=!1),Array.isArray(t)||(t=[t]),this._currentOutput.options(t.reduce(function(p,o){var f=String(o).split(" ");return i&&f.length===2?p.push(f[0],f[1]):p.push(o),p},[])),this},e.filterGraph=e.complexFilter=function(t,i){if(this._complexFilters.clear(),Array.isArray(t)||(t=[t]),this._complexFilters("-filter_complex",n.makeFilterStrings(t).join(";")),Array.isArray(i)){var p=this;i.forEach(function(o){p._complexFilters("-map",o.replace(n.streamRegexp,"[$1]"))})}else typeof i=="string"&&this._complexFilters("-map",i.replace(n.streamRegexp,"[$1]"));return this}},custom}function commonjsRequire(n){throw new Error('Could not dynamically require "'+n+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var misc,hasRequiredMisc;function requireMisc(){if(hasRequiredMisc)return misc;hasRequiredMisc=1;var n=require$$1;return misc=function(e){e.usingPreset=e.preset=function(t){if(typeof t=="function")t(this);else try{var i=n.join(this.options.presets,t),p=commonjsRequire(i);if(typeof p.load=="function")p.load(this);else throw new Error("preset "+i+" has no load() function")}catch(o){throw new Error("preset "+i+" could not be loaded: "+o.message)}return this}},misc}var async={exports:{}},hasRequiredAsync;function requireAsync(){return hasRequiredAsync||(hasRequiredAsync=1,function(n){(function(){var e={},t,i;t=this,t!=null&&(i=t.async),e.noConflict=function(){return t.async=i,e};function p(r){var s=!1;return function(){if(s)throw new Error("Callback was already called.");s=!0,r.apply(t,arguments)}}var o=function(r,s){if(r.forEach)return r.forEach(s);for(var u=0;u<r.length;u+=1)s(r[u],u,r)},f=function(r,s){if(r.map)return r.map(s);var u=[];return o(r,function(c,l,h){u.push(s(c,l,h))}),u},a=function(r,s,u){return r.reduce?r.reduce(s,u):(o(r,function(c,l,h){u=s(u,c,l,h)}),u)},d=function(r){if(Object.keys)return Object.keys(r);var s=[];for(var u in r)r.hasOwnProperty(u)&&s.push(u);return s};typeof process>"u"||!process.nextTick?typeof setImmediate=="function"?(e.nextTick=function(r){setImmediate(r)},e.setImmediate=e.nextTick):(e.nextTick=function(r){setTimeout(r,0)},e.setImmediate=e.nextTick):(e.nextTick=process.nextTick,typeof setImmediate<"u"?e.setImmediate=function(r){setImmediate(r)}:e.setImmediate=e.nextTick),e.each=function(r,s,u){if(u=u||function(){},!r.length)return u();var c=0;o(r,function(l){s(l,p(function(h){h?(u(h),u=function(){}):(c+=1,c>=r.length&&u(null))}))})},e.forEach=e.each,e.eachSeries=function(r,s,u){if(u=u||function(){},!r.length)return u();var c=0,l=function(){s(r[c],function(h){h?(u(h),u=function(){}):(c+=1,c>=r.length?u(null):l())})};l()},e.forEachSeries=e.eachSeries,e.eachLimit=function(r,s,u,c){var l=y(s);l.apply(null,[r,u,c])},e.forEachLimit=e.eachLimit;var y=function(r){return function(s,u,c){if(c=c||function(){},!s.length||r<=0)return c();var l=0,h=0,$=0;(function O(){if(l>=s.length)return c();for(;$<r&&h<s.length;)h+=1,$+=1,u(s[h-1],function(S){S?(c(S),c=function(){}):(l+=1,$-=1,l>=s.length?c():O())})})()}},g=function(r){return function(){var s=Array.prototype.slice.call(arguments);return r.apply(null,[e.each].concat(s))}},P=function(r,s){return function(){var u=Array.prototype.slice.call(arguments);return s.apply(null,[y(r)].concat(u))}},v=function(r){return function(){var s=Array.prototype.slice.call(arguments);return r.apply(null,[e.eachSeries].concat(s))}},A=function(r,s,u,c){var l=[];s=f(s,function(h,$){return{index:$,value:h}}),r(s,function(h,$){u(h.value,function(O,S){l[h.index]=S,$(O)})},function(h){c(h,l)})};e.map=g(A),e.mapSeries=v(A),e.mapLimit=function(r,s,u,c){return x(s)(r,u,c)};var x=function(r){return P(r,A)};e.reduce=function(r,s,u,c){e.eachSeries(r,function(l,h){u(s,l,function($,O){s=O,h($)})},function(l){c(l,s)})},e.inject=e.reduce,e.foldl=e.reduce,e.reduceRight=function(r,s,u,c){var l=f(r,function(h){return h}).reverse();e.reduce(l,s,u,c)},e.foldr=e.reduceRight;var q=function(r,s,u,c){var l=[];s=f(s,function(h,$){return{index:$,value:h}}),r(s,function(h,$){u(h.value,function(O){O&&l.push(h),$()})},function(h){c(f(l.sort(function($,O){return $.index-O.index}),function($){return $.value}))})};e.filter=g(q),e.filterSeries=v(q),e.select=e.filter,e.selectSeries=e.filterSeries;var w=function(r,s,u,c){var l=[];s=f(s,function(h,$){return{index:$,value:h}}),r(s,function(h,$){u(h.value,function(O){O||l.push(h),$()})},function(h){c(f(l.sort(function($,O){return $.index-O.index}),function($){return $.value}))})};e.reject=g(w),e.rejectSeries=v(w);var C=function(r,s,u,c){r(s,function(l,h){u(l,function($){$?(c(l),c=function(){}):h()})},function(l){c()})};e.detect=g(C),e.detectSeries=v(C),e.some=function(r,s,u){e.each(r,function(c,l){s(c,function(h){h&&(u(!0),u=function(){}),l()})},function(c){u(!1)})},e.any=e.some,e.every=function(r,s,u){e.each(r,function(c,l){s(c,function(h){h||(u(!1),u=function(){}),l()})},function(c){u(!0)})},e.all=e.every,e.sortBy=function(r,s,u){e.map(r,function(c,l){s(c,function(h,$){h?l(h):l(null,{value:c,criteria:$})})},function(c,l){if(c)return u(c);var h=function($,O){var S=$.criteria,I=O.criteria;return S<I?-1:S>I?1:0};u(null,f(l.sort(h),function($){return $.value}))})},e.auto=function(r,s){s=s||function(){};var u=d(r);if(!u.length)return s(null);var c={},l=[],h=function(S){l.unshift(S)},$=function(S){for(var I=0;I<l.length;I+=1)if(l[I]===S){l.splice(I,1);return}},O=function(){o(l.slice(0),function(S){S()})};h(function(){d(c).length===u.length&&(s(null,c),s=function(){})}),o(u,function(S){var I=r[S]instanceof Function?[r[S]]:r[S],T=function(k){var R=Array.prototype.slice.call(arguments,1);if(R.length<=1&&(R=R[0]),k){var W={};o(d(c),function(j){W[j]=c[j]}),W[S]=R,s(k,W),s=function(){}}else c[S]=R,e.setImmediate(O)},M=I.slice(0,Math.abs(I.length-1))||[],D=function(){return a(M,function(k,R){return k&&c.hasOwnProperty(R)},!0)&&!c.hasOwnProperty(S)};if(D())I[I.length-1](T,c);else{var z=function(){D()&&($(z),I[I.length-1](T,c))};h(z)}})},e.waterfall=function(r,s){if(s=s||function(){},r.constructor!==Array){var u=new Error("First argument to waterfall must be an array of functions");return s(u)}if(!r.length)return s();var c=function(l){return function(h){if(h)s.apply(null,arguments),s=function(){};else{var $=Array.prototype.slice.call(arguments,1),O=l.next();O?$.push(c(O)):$.push(s),e.setImmediate(function(){l.apply(null,$)})}}};c(e.iterator(r))()};var b=function(r,s,u){if(u=u||function(){},s.constructor===Array)r.map(s,function(l,h){l&&l(function($){var O=Array.prototype.slice.call(arguments,1);O.length<=1&&(O=O[0]),h.call(null,$,O)})},u);else{var c={};r.each(d(s),function(l,h){s[l](function($){var O=Array.prototype.slice.call(arguments,1);O.length<=1&&(O=O[0]),c[l]=O,h($)})},function(l){u(l,c)})}};e.parallel=function(r,s){b({map:e.map,each:e.each},r,s)},e.parallelLimit=function(r,s,u){b({map:x(s),each:y(s)},r,u)},e.series=function(r,s){if(s=s||function(){},r.constructor===Array)e.mapSeries(r,function(c,l){c&&c(function(h){var $=Array.prototype.slice.call(arguments,1);$.length<=1&&($=$[0]),l.call(null,h,$)})},s);else{var u={};e.eachSeries(d(r),function(c,l){r[c](function(h){var $=Array.prototype.slice.call(arguments,1);$.length<=1&&($=$[0]),u[c]=$,l(h)})},function(c){s(c,u)})}},e.iterator=function(r){var s=function(u){var c=function(){return r.length&&r[u].apply(null,arguments),c.next()};return c.next=function(){return u<r.length-1?s(u+1):null},c};return s(0)},e.apply=function(r){var s=Array.prototype.slice.call(arguments,1);return function(){return r.apply(null,s.concat(Array.prototype.slice.call(arguments)))}};var E=function(r,s,u,c){var l=[];r(s,function(h,$){u(h,function(O,S){l=l.concat(S||[]),$(O)})},function(h){c(h,l)})};e.concat=g(E),e.concatSeries=v(E),e.whilst=function(r,s,u){r()?s(function(c){if(c)return u(c);e.whilst(r,s,u)}):u()},e.doWhilst=function(r,s,u){r(function(c){if(c)return u(c);s()?e.doWhilst(r,s,u):u()})},e.until=function(r,s,u){r()?u():s(function(c){if(c)return u(c);e.until(r,s,u)})},e.doUntil=function(r,s,u){r(function(c){if(c)return u(c);s()?u():e.doUntil(r,s,u)})},e.queue=function(r,s){s===void 0&&(s=1);function u(h,$,O,S){$.constructor!==Array&&($=[$]),o($,function(I){var T={data:I,callback:typeof S=="function"?S:null};O?h.tasks.unshift(T):h.tasks.push(T),h.saturated&&h.tasks.length===s&&h.saturated(),e.setImmediate(h.process)})}var c=0,l={tasks:[],concurrency:s,saturated:null,empty:null,drain:null,push:function(h,$){u(l,h,!1,$)},unshift:function(h,$){u(l,h,!0,$)},process:function(){if(c<l.concurrency&&l.tasks.length){var h=l.tasks.shift();l.empty&&l.tasks.length===0&&l.empty(),c+=1;var $=function(){c-=1,h.callback&&h.callback.apply(h,arguments),l.drain&&l.tasks.length+c===0&&l.drain(),l.process()},O=p($);r(h.data,O)}},length:function(){return l.tasks.length},running:function(){return c}};return l},e.cargo=function(r,s){var u=!1,c=[],l={tasks:c,payload:s,saturated:null,empty:null,drain:null,push:function(h,$){h.constructor!==Array&&(h=[h]),o(h,function(O){c.push({data:O,callback:typeof $=="function"?$:null}),l.saturated&&c.length===s&&l.saturated()}),e.setImmediate(l.process)},process:function h(){if(!u){if(c.length===0){l.drain&&l.drain();return}var $=typeof s=="number"?c.splice(0,s):c.splice(0),O=f($,function(S){return S.data});l.empty&&l.empty(),u=!0,r(O,function(){u=!1;var S=arguments;o($,function(I){I.callback&&I.callback.apply(null,S)}),h()})}},length:function(){return c.length},running:function(){return u}};return l};var F=function(r){return function(s){var u=Array.prototype.slice.call(arguments,1);s.apply(null,u.concat([function(c){var l=Array.prototype.slice.call(arguments,1);typeof console<"u"&&(c?console.error&&console.error(c):console[r]&&o(l,function(h){console[r](h)}))}]))}};e.log=F("log"),e.dir=F("dir"),e.memoize=function(r,s){var u={},c={};s=s||function(h){return h};var l=function(){var h=Array.prototype.slice.call(arguments),$=h.pop(),O=s.apply(null,h);O in u?$.apply(null,u[O]):O in c?c[O].push($):(c[O]=[$],r.apply(null,h.concat([function(){u[O]=arguments;var S=c[O];delete c[O];for(var I=0,T=S.length;I<T;I++)S[I].apply(null,arguments)}])))};return l.memo=u,l.unmemoized=r,l},e.unmemoize=function(r){return function(){return(r.unmemoized||r).apply(null,arguments)}},e.times=function(r,s,u){for(var c=[],l=0;l<r;l++)c.push(l);return e.map(c,s,u)},e.timesSeries=function(r,s,u){for(var c=[],l=0;l<r;l++)c.push(l);return e.mapSeries(c,s,u)},e.compose=function(){var r=Array.prototype.reverse.call(arguments);return function(){var s=this,u=Array.prototype.slice.call(arguments),c=u.pop();e.reduce(r,u,function(l,h,$){h.apply(s,l.concat([function(){var O=arguments[0],S=Array.prototype.slice.call(arguments,1);$(O,S)}]))},function(l,h){c.apply(s,[l].concat(h))})}};var m=function(r,s){var u=function(){var l=this,h=Array.prototype.slice.call(arguments),$=h.pop();return r(s,function(O,S){O.apply(l,h.concat([S]))},$)};if(arguments.length>2){var c=Array.prototype.slice.call(arguments,2);return u.apply(this,c)}else return u};e.applyEach=g(m),e.applyEachSeries=v(m),e.forever=function(r,s){function u(c){if(c){if(s)return s(c);throw c}r(u)}u()},n.exports?n.exports=e:t.async=e})()}(async)),async.exports}var processor,hasRequiredProcessor;function requireProcessor(){if(hasRequiredProcessor)return processor;hasRequiredProcessor=1;var n=require$$0$1.spawn,e=requireAsync(),t=utilsExports;function i(p){p._inputs[0].isStream||p.ffprobe(0,function(f,a){p._ffprobeData=a})}return processor=function(p){p._spawnFfmpeg=function(o,f,a,d){typeof f=="function"&&(d=a,a=f,f={}),typeof d>"u"&&(d=a,a=function(){});var y="stdoutLines"in f?f.stdoutLines:this.options.stdoutLines;this._getFfmpegPath(function(g,P){if(g)return d(g);if(!P||P.length===0)return d(new Error("Cannot find ffmpeg"));f.niceness&&f.niceness!==0&&!t.isWindows&&(o.unshift("-n",f.niceness,P),P="nice");var v=t.linesRing(y),A=!1,x=t.linesRing(y),q=!1,w=n(P,o,f);w.stderr&&w.stderr.setEncoding("utf8"),w.on("error",function(F){d(F)});var C=null;function b(F){F&&(C=F),E&&(A||!f.captureStdout)&&q&&d(C,v,x)}var E=!1;w.on("exit",function(F,m){E=!0,m?b(new Error("ffmpeg was killed with signal "+m)):F?b(new Error("ffmpeg exited with code "+F)):b()}),f.captureStdout&&(w.stdout.on("data",function(F){v.append(F)}),w.stdout.on("close",function(){v.close(),A=!0,b()})),w.stderr.on("data",function(F){x.append(F)}),w.stderr.on("close",function(){x.close(),q=!0,b()}),a(w,v,x)})},p._getArguments=function(){var o=this._complexFilters.get(),f=this._outputs.some(function(a){return a.isFile});return[].concat(this._inputs.reduce(function(a,d){var y=typeof d.source=="string"?d.source:"pipe:0";return a.concat(d.options.get(),["-i",y])},[]),this._global.get(),f?["-y"]:[],o,this._outputs.reduce(function(a,d){var y=t.makeFilterStrings(d.sizeFilters.get()),g=d.audioFilters.get(),P=d.videoFilters.get().concat(y),v;return d.target?typeof d.target=="string"?v=[d.target]:v=["pipe:1"]:v=[],a.concat(d.audio.get(),g.length?["-filter:a",g.join(",")]:[],d.video.get(),P.length?["-filter:v",P.join(",")]:[],d.options.get(),v)},[]))},p._prepare=function(o,f){var a=this;e.waterfall([function(d){a._checkCapabilities(d)},function(d){if(!f)return d();a.ffprobe(0,function(y,g){y||(a._ffprobeData=g),d()})},function(d){var y=a._outputs.some(function(g){return g.flags.flvmeta&&!g.isFile&&(a.logger.warn("Updating flv metadata is only supported for files"),g.flags.flvmeta=!1),g.flags.flvmeta});y?a._getFlvtoolPath(function(g){d(g)}):d()},function(d){var y;try{y=a._getArguments()}catch(g){return d(g)}d(null,y)},function(d,y){a.availableEncoders(function(g,P){for(var v=0;v<d.length;v++)(d[v]==="-acodec"||d[v]==="-vcodec")&&(v++,d[v]in P&&P[d[v]].experimental&&(d.splice(v+1,0,"-strict","experimental"),v+=2));y(null,d)})}],o),f||(this.listeners("progress").length>0?i(this):this.once("newListener",function(d){d==="progress"&&i(this)}))},p.exec=p.execute=p.run=function(){var o=this,f=this._outputs.some(function(P){return"target"in P});if(!f)throw new Error("No output specified");var a=this._outputs.filter(function(P){return typeof P.target!="string"})[0],d=this._inputs.filter(function(P){return typeof P.source!="string"})[0],y=!1;function g(P,v,A){y||(y=!0,P?o.emit("error",P,v,A):o.emit("end",v,A))}return o._prepare(function(P,v){if(P)return g(P);o._spawnFfmpeg(v,{captureStdout:!a,niceness:o.options.niceness,cwd:o.options.cwd,windowsHide:!0},function(x,q,w){if(o.ffmpegProc=x,o.emit("start","ffmpeg "+v.join(" ")),d&&(d.source.on("error",function(E){var F=new Error("Input stream error: "+E.message);F.inputStreamError=E,g(F),x.kill()}),d.source.resume(),d.source.pipe(x.stdin),x.stdin.on("error",function(){})),o.options.timeout&&(o.processTimer=setTimeout(function(){var E="process ran into a timeout ("+o.options.timeout+"s)";g(new Error(E),q.get(),w.get()),x.kill()},o.options.timeout*1e3)),a&&(x.stdout.pipe(a.target,a.pipeopts),a.target.on("close",function(){o.logger.debug("Output stream closed, scheduling kill for ffmpeg process"),setTimeout(function(){g(new Error("Output stream closed")),x.kill()},20)}),a.target.on("error",function(E){o.logger.debug("Output stream error, killing ffmpeg process");var F=new Error("Output stream error: "+E.message);F.outputStreamError=E,g(F,q.get(),w.get()),x.kill("SIGKILL")})),w){if(o.listeners("stderr").length&&w.callback(function(E){o.emit("stderr",E)}),o.listeners("codecData").length){var C=!1,b={};w.callback(function(E){C||(C=t.extractCodecData(o,E,b))})}o.listeners("progress").length&&w.callback(function(E){t.extractProgress(o,E)})}},function(x,q,w){if(clearTimeout(o.processTimer),delete o.ffmpegProc,x)x.message.match(/ffmpeg exited with code/)&&(x.message+=": "+t.extractError(w.get())),g(x,q.get(),w.get());else{var C=o._outputs.filter(function(b){return b.flags.flvmeta});C.length?o._getFlvtoolPath(function(b,E){if(b)return g(b);e.each(C,function(F,m){n(E,["-U",F.target],{windowsHide:!0}).on("error",function(r){m(new Error("Error running "+E+" on "+F.target+": "+r.message))}).on("exit",function(r,s){r!==0||s?m(new Error(E+" "+(s?"received signal "+s:"exited with code "+r))+" when running on "+F.target):m()})},function(F){F?g(F):g(null,q.get(),w.get())})}):g(null,q.get(),w.get())}})}),this},p.renice=function(o){if(!t.isWindows&&(o=o||0,(o<-20||o>20)&&this.logger.warn("Invalid niceness value: "+o+", must be between -20 and 20"),o=Math.min(20,Math.max(-20,o)),this.options.niceness=o,this.ffmpegProc)){var f=this.logger,a=this.ffmpegProc.pid,d=n("renice",[o,"-p",a],{windowsHide:!0});d.on("error",function(y){f.warn("could not renice process "+a+": "+y.message)}),d.on("exit",function(y,g){g?f.warn("could not renice process "+a+": renice was killed by signal "+g):y?f.warn("could not renice process "+a+": renice exited with "+y):f.info("successfully reniced process "+a+" to "+o+" niceness")})}return this},p.kill=function(o){return this.ffmpegProc?this.ffmpegProc.kill(o||"SIGKILL"):this.logger.warn("No running ffmpeg process, cannot send signal"),this}},processor}var capabilities,hasRequiredCapabilities;function requireCapabilities(){if(hasRequiredCapabilities)return capabilities;hasRequiredCapabilities=1;var n=require$$0,e=require$$1,t=requireAsync(),i=utilsExports,p=/^\s*([D ])([E ])([VAS])([S ])([D ])([T ]) ([^ ]+) +(.*)$/,o=/^\s*([D\.])([E\.])([VAS])([I\.])([L\.])([S\.]) ([^ ]+) +(.*)$/,f=/\(encoders:([^\)]+)\)/,a=/\(decoders:([^\)]+)\)/,d=/^\s*([VAS\.])([F\.])([S\.])([X\.])([B\.])([D\.]) ([^ ]+) +(.*)$/,y=/^\s*([D ])([E ])\s+([^ ]+)\s+(.*)$/,g=/\r\n|\r|\n/,P=/^(?: [T\.][S\.][C\.] )?([^ ]+) +(AA?|VV?|\|)->(AA?|VV?|\|) +(.*)$/,v={};return capabilities=function(A){A.setFfmpegPath=function(x){return v.ffmpegPath=x,this},A.setFfprobePath=function(x){return v.ffprobePath=x,this},A.setFlvtoolPath=function(x){return v.flvtoolPath=x,this},A._forgetPaths=function(){delete v.ffmpegPath,delete v.ffprobePath,delete v.flvtoolPath},A._getFfmpegPath=function(x){if("ffmpegPath"in v)return x(null,v.ffmpegPath);t.waterfall([function(q){process.env.FFMPEG_PATH?n.exists(process.env.FFMPEG_PATH,function(w){w?q(null,process.env.FFMPEG_PATH):q(null,"")}):q(null,"")},function(q,w){if(q.length)return w(null,q);i.which("ffmpeg",function(C,b){w(C,b)})}],function(q,w){q?x(q):x(null,v.ffmpegPath=w||"")})},A._getFfprobePath=function(x){var q=this;if("ffprobePath"in v)return x(null,v.ffprobePath);t.waterfall([function(w){process.env.FFPROBE_PATH?n.exists(process.env.FFPROBE_PATH,function(C){w(null,C?process.env.FFPROBE_PATH:"")}):w(null,"")},function(w,C){if(w.length)return C(null,w);i.which("ffprobe",function(b,E){C(b,E)})},function(w,C){if(w.length)return C(null,w);q._getFfmpegPath(function(b,E){if(b)C(b);else if(E.length){var F=i.isWindows?"ffprobe.exe":"ffprobe",m=e.join(e.dirname(E),F);n.exists(m,function(r){C(null,r?m:"")})}else C(null,"")})}],function(w,C){w?x(w):x(null,v.ffprobePath=C||"")})},A._getFlvtoolPath=function(x){if("flvtoolPath"in v)return x(null,v.flvtoolPath);t.waterfall([function(q){process.env.FLVMETA_PATH?n.exists(process.env.FLVMETA_PATH,function(w){q(null,w?process.env.FLVMETA_PATH:"")}):q(null,"")},function(q,w){if(q.length)return w(null,q);process.env.FLVTOOL2_PATH?n.exists(process.env.FLVTOOL2_PATH,function(C){w(null,C?process.env.FLVTOOL2_PATH:"")}):w(null,"")},function(q,w){if(q.length)return w(null,q);i.which("flvmeta",function(C,b){w(C,b)})},function(q,w){if(q.length)return w(null,q);i.which("flvtool2",function(C,b){w(C,b)})}],function(q,w){q?x(q):x(null,v.flvtoolPath=w||"")})},A.availableFilters=A.getAvailableFilters=function(x){if("filters"in v)return x(null,v.filters);this._spawnFfmpeg(["-filters"],{captureStdout:!0,stdoutLines:0},function(q,w){if(q)return x(q);var C=w.get(),b=C.split(`
`),E={},F={A:"audio",V:"video","|":"none"};b.forEach(function(m){var r=m.match(P);r&&(E[r[1]]={description:r[4],input:F[r[2].charAt(0)],multipleInputs:r[2].length>1,output:F[r[3].charAt(0)],multipleOutputs:r[3].length>1})}),x(null,v.filters=E)})},A.availableCodecs=A.getAvailableCodecs=function(x){if("codecs"in v)return x(null,v.codecs);this._spawnFfmpeg(["-codecs"],{captureStdout:!0,stdoutLines:0},function(q,w){if(q)return x(q);var C=w.get(),b=C.split(g),E={};b.forEach(function(F){var m=F.match(p);if(m&&m[7]!=="="&&(E[m[7]]={type:{V:"video",A:"audio",S:"subtitle"}[m[3]],description:m[8],canDecode:m[1]==="D",canEncode:m[2]==="E",drawHorizBand:m[4]==="S",directRendering:m[5]==="D",weirdFrameTruncation:m[6]==="T"}),m=F.match(o),m&&m[7]!=="="){var r=E[m[7]]={type:{V:"video",A:"audio",S:"subtitle"}[m[3]],description:m[8],canDecode:m[1]==="D",canEncode:m[2]==="E",intraFrameOnly:m[4]==="I",isLossy:m[5]==="L",isLossless:m[6]==="S"},s=r.description.match(f);s=s?s[1].trim().split(" "):[];var u=r.description.match(a);if(u=u?u[1].trim().split(" "):[],s.length||u.length){var c={};i.copy(r,c),delete c.canEncode,delete c.canDecode,s.forEach(function(l){E[l]={},i.copy(c,E[l]),E[l].canEncode=!0}),u.forEach(function(l){l in E||(E[l]={},i.copy(c,E[l])),E[l].canDecode=!0})}}}),x(null,v.codecs=E)})},A.availableEncoders=A.getAvailableEncoders=function(x){if("encoders"in v)return x(null,v.encoders);this._spawnFfmpeg(["-encoders"],{captureStdout:!0,stdoutLines:0},function(q,w){if(q)return x(q);var C=w.get(),b=C.split(g),E={};b.forEach(function(F){var m=F.match(d);m&&m[7]!=="="&&(E[m[7]]={type:{V:"video",A:"audio",S:"subtitle"}[m[1]],description:m[8],frameMT:m[2]==="F",sliceMT:m[3]==="S",experimental:m[4]==="X",drawHorizBand:m[5]==="B",directRendering:m[6]==="D"})}),x(null,v.encoders=E)})},A.availableFormats=A.getAvailableFormats=function(x){if("formats"in v)return x(null,v.formats);this._spawnFfmpeg(["-formats"],{captureStdout:!0,stdoutLines:0},function(q,w){if(q)return x(q);var C=w.get(),b=C.split(g),E={};b.forEach(function(F){var m=F.match(y);m&&m[3].split(",").forEach(function(r){r in E||(E[r]={description:m[4],canDemux:!1,canMux:!1}),m[1]==="D"&&(E[r].canDemux=!0),m[2]==="E"&&(E[r].canMux=!0)})}),x(null,v.formats=E)})},A._checkCapabilities=function(x){var q=this;t.waterfall([function(w){q.availableFormats(w)},function(w,C){var b;if(b=q._outputs.reduce(function(E,F){var m=F.options.find("-f",1);return m&&(!(m[0]in w)||!w[m[0]].canMux)&&E.push(m),E},[]),b.length===1)return C(new Error("Output format "+b[0]+" is not available"));if(b.length>1)return C(new Error("Output formats "+b.join(", ")+" are not available"));if(b=q._inputs.reduce(function(E,F){var m=F.options.find("-f",1);return m&&(!(m[0]in w)||!w[m[0]].canDemux)&&E.push(m[0]),E},[]),b.length===1)return C(new Error("Input format "+b[0]+" is not available"));if(b.length>1)return C(new Error("Input formats "+b.join(", ")+" are not available"));C()},function(w){q.availableEncoders(w)},function(w,C){var b;if(b=q._outputs.reduce(function(E,F){var m=F.audio.find("-acodec",1);return m&&m[0]!=="copy"&&(!(m[0]in w)||w[m[0]].type!=="audio")&&E.push(m[0]),E},[]),b.length===1)return C(new Error("Audio codec "+b[0]+" is not available"));if(b.length>1)return C(new Error("Audio codecs "+b.join(", ")+" are not available"));if(b=q._outputs.reduce(function(E,F){var m=F.video.find("-vcodec",1);return m&&m[0]!=="copy"&&(!(m[0]in w)||w[m[0]].type!=="video")&&E.push(m[0]),E},[]),b.length===1)return C(new Error("Video codec "+b[0]+" is not available"));if(b.length>1)return C(new Error("Video codecs "+b.join(", ")+" are not available"));C()}],x)}},capabilities}var ffprobe,hasRequiredFfprobe;function requireFfprobe(){if(hasRequiredFfprobe)return ffprobe;hasRequiredFfprobe=1;var n=require$$0$1.spawn;function e(p){return p.match(/^TAG:/)}function t(p){return p.match(/^DISPOSITION:/)}function i(p){var o=p.split(/\r\n|\r|\n/);o=o.filter(function(P){return P.length>0});var f={streams:[],format:{},chapters:[]};function a(P){for(var v={},A=o.shift();typeof A<"u";){if(A.toLowerCase()=="[/"+P+"]")return v;if(A.match(/^\[/)){A=o.shift();continue}var x=A.match(/^([^=]+)=(.*)$/);x&&(!x[1].match(/^TAG:/)&&x[2].match(/^[0-9]+(\.[0-9]+)?$/)?v[x[1]]=Number(x[2]):v[x[1]]=x[2]),A=o.shift()}return v}for(var d=o.shift();typeof d<"u";){if(d.match(/^\[stream/i)){var y=a("stream");f.streams.push(y)}else if(d.match(/^\[chapter/i)){var g=a("chapter");f.chapters.push(g)}else d.toLowerCase()==="[format]"&&(f.format=a("format"));d=o.shift()}return f}return ffprobe=function(p){p.ffprobe=function(){var o,f=null,a=[],d,d=arguments[arguments.length-1],y=!1;function g(P,v){y||(y=!0,d(P,v))}switch(arguments.length){case 3:f=arguments[0],a=arguments[1];break;case 2:typeof arguments[0]=="number"?f=arguments[0]:Array.isArray(arguments[0])&&(a=arguments[0]);break}if(f===null){if(!this._currentInput)return g(new Error("No input specified"));o=this._currentInput}else if(o=this._inputs[f],!o)return g(new Error("Invalid input index"));this._getFfprobePath(function(P,v){if(P)return g(P);if(!v)return g(new Error("Cannot find ffprobe"));var A="",x=!1,q="",w=!1,C=o.isStream?"pipe:0":o.source,b=n(v,["-show_streams","-show_format"].concat(a,C),{windowsHide:!0});o.isStream&&(b.stdin.on("error",function(r){["ECONNRESET","EPIPE","EOF"].indexOf(r.code)>=0||g(r)}),b.stdin.on("close",function(){o.source.pause(),o.source.unpipe(b.stdin)}),o.source.pipe(b.stdin)),b.on("error",d);var E=null;function F(r){if(r&&(E=r),m&&x&&w){if(E)return q&&(E.message+=`
`+q),g(E);var s=i(A);[s.format].concat(s.streams).forEach(function(u){if(u){var c=Object.keys(u).filter(e);c.length&&(u.tags=u.tags||{},c.forEach(function(h){u.tags[h.substr(4)]=u[h],delete u[h]}));var l=Object.keys(u).filter(t);l.length&&(u.disposition=u.disposition||{},l.forEach(function(h){u.disposition[h.substr(12)]=u[h],delete u[h]}))}}),g(null,s)}}var m=!1;b.on("exit",function(r,s){m=!0,r?F(new Error("ffprobe exited with code "+r)):s?F(new Error("ffprobe was killed with signal "+s)):F()}),b.stdout.on("data",function(r){A+=r}),b.stdout.on("close",function(){x=!0,F()}),b.stderr.on("data",function(r){q+=r}),b.stderr.on("close",function(){w=!0,F()})})}},ffprobe}var recipes,hasRequiredRecipes;function requireRecipes(){if(hasRequiredRecipes)return recipes;hasRequiredRecipes=1;var n=require$$0,e=require$$1,t=require$$2.PassThrough,i=requireAsync(),p=utilsExports;return recipes=function(f){f.saveToFile=f.save=function(a){return this.output(a).run(),this},f.writeToStream=f.pipe=f.stream=function(a,d){if(a&&!("writable"in a)&&(d=a,a=void 0),!a){if(process.version.match(/v0\.8\./))throw new Error("PassThrough stream is not supported on node v0.8");a=new t}return this.output(a,d).run(),a},f.takeScreenshots=f.thumbnail=f.thumbnails=f.screenshot=f.screenshots=function(a,d){var y=this,g=this._currentInput.source;if(a=a||{count:1},typeof a=="number"&&(a={count:a}),"folder"in a||(a.folder=d||"."),"timestamps"in a&&(a.timemarks=a.timestamps),!("timemarks"in a)){if(!a.count)throw new Error("Cannot take screenshots: neither a count nor a timemark list are specified");var P=100/(1+a.count);a.timemarks=[];for(var v=0;v<a.count;v++)a.timemarks.push(P*(v+1)+"%")}if("size"in a){var A=a.size.match(/^(\d+)x(\d+)$/),x=a.size.match(/^(\d+)x\?$/),q=a.size.match(/^\?x(\d+)$/),w=a.size.match(/^(\d+)%$/);if(!A&&!x&&!q&&!w)throw new Error("Invalid size parameter: "+a.size)}var C;function b(E){C?E(null,C):y.ffprobe(function(F,m){C=m,E(F,m)})}return i.waterfall([function(F){if(a.timemarks.some(function(m){return(""+m).match(/^[\d.]+%$/)})){if(typeof g!="string")return F(new Error("Cannot compute screenshot timemarks with an input stream, please specify fixed timemarks"));b(function(m,r){if(m)F(m);else{var s=r.streams.reduce(function(c,l){return l.codec_type==="video"&&l.width*l.height>c.width*c.height?l:c},{width:0,height:0});if(s.width===0)return F(new Error("No video stream in input, cannot take screenshots"));var u=Number(s.duration);if(isNaN(u)&&(u=Number(r.format.duration)),isNaN(u))return F(new Error("Could not get input duration, please specify fixed timemarks"));a.timemarks=a.timemarks.map(function(c){return(""+c).match(/^([\d.]+)%$/)?u*parseFloat(c)/100:c}),F()}})}else F()},function(F){a.timemarks=a.timemarks.map(function(m){return p.timemarkToSeconds(m)}).sort(function(m,r){return m-r}),F()},function(F){var m=a.filename||"tn.png";if(m.indexOf(".")===-1&&(m+=".png"),a.timemarks.length>1&&!m.match(/%(s|0*i)/)){var r=e.extname(m);m=e.join(e.dirname(m),e.basename(m,r)+"_%i"+r)}F(null,m)},function(F,m){if(F.match(/%[bf]/)){if(typeof g!="string")return m(new Error("Cannot replace %f or %b when using an input stream"));F=F.replace(/%f/g,e.basename(g)).replace(/%b/g,e.basename(g,e.extname(g)))}m(null,F)},function(F,m){if(F.match(/%[whr]/)){if(A)return m(null,F,A[1],A[2]);b(function(r,s){if(r)return m(new Error("Could not determine video resolution to replace %w, %h or %r"));var u=s.streams.reduce(function(h,$){return $.codec_type==="video"&&$.width*$.height>h.width*h.height?$:h},{width:0,height:0});if(u.width===0)return m(new Error("No video stream in input, cannot replace %w, %h or %r"));var c=u.width,l=u.height;x?(l=l*Number(x[1])/c,c=Number(x[1])):q?(c=c*Number(q[1])/l,l=Number(q[1])):w&&(c=c*Number(w[1])/100,l=l*Number(w[1])/100),m(null,F,Math.round(c/2)*2,Math.round(l/2)*2)})}else m(null,F,-1,-1)},function(F,m,r,s){F=F.replace(/%r/g,"%wx%h").replace(/%w/g,m).replace(/%h/g,r),s(null,F)},function(F,m){var r=a.timemarks.map(function(s,u){return F.replace(/%s/g,p.timemarkToSeconds(s)).replace(/%(0*)i/g,function(c,l){var h=""+(u+1);return l.substr(0,Math.max(0,l.length+1-h.length))+h})});y.emit("filenames",r),m(null,r)},function(F,m){n.exists(a.folder,function(r){r?m(null,F):n.mkdir(a.folder,function(s){s?m(s):m(null,F)})})}],function(F,m){if(F)return y.emit("error",F);var r=a.timemarks.length,s,u=[s={filter:"split",options:r,outputs:[]}];if("size"in a){y.size(a.size);var c=y._currentOutput.sizeFilters.get().map(function(O,S){return S>0&&(O.inputs="size"+(S-1)),O.outputs="size"+S,O});s.inputs="size"+(c.length-1),u=c.concat(u),y._currentOutput.sizeFilters.clear()}for(var l=0,h=0;h<r;h++){var $="screen"+h;s.outputs.push($),h===0&&(l=a.timemarks[h],y.seekInput(l)),y.output(e.join(a.folder,m[h])).frames(1).map($),h>0&&y.seek(a.timemarks[h]-l)}y.complexFilter(u),y.run()}),this},f.mergeToFile=f.concatenate=f.concat=function(a,d){var y=this._inputs.filter(function(P){return!P.isStream})[0],g=this;return this.ffprobe(this._inputs.indexOf(y),function(P,v){if(P)return g.emit("error",P);var A=v.streams.some(function(q){return q.codec_type==="audio"}),x=v.streams.some(function(q){return q.codec_type==="video"});g.output(a,d).complexFilter({filter:"concat",options:{n:g._inputs.length,v:x?1:0,a:A?1:0}}).run()}),this}},recipes}var path=require$$1,util=require$$1$2,EventEmitter=require$$2$1.EventEmitter,utils=utilsExports;function FfmpegCommand(n,e){if(!(this instanceof FfmpegCommand))return new FfmpegCommand(n,e);EventEmitter.call(this),typeof n=="object"&&!("readable"in n)?e=n:(e=e||{},e.source=n),this._inputs=[],e.source&&this.input(e.source),this._outputs=[],this.output();var t=this;["_global","_complexFilters"].forEach(function(i){t[i]=utils.args()}),e.stdoutLines="stdoutLines"in e?e.stdoutLines:100,e.presets=e.presets||e.preset||path.join(__dirname,"presets"),e.niceness=e.niceness||e.priority||0,this.options=e,this.logger=e.logger||{debug:function(){},info:function(){},warn:function(){},error:function(){}}}util.inherits(FfmpegCommand,EventEmitter);var fluentFfmpeg$1=FfmpegCommand;FfmpegCommand.prototype.clone=function(){var n=new FfmpegCommand,e=this;return n.options=this.options,n.logger=this.logger,n._inputs=this._inputs.map(function(t){return{source:t.source,options:t.options.clone()}}),"target"in this._outputs[0]?(n._outputs=[],n.output()):(n._outputs=[n._currentOutput={flags:{}}],["audio","audioFilters","video","videoFilters","sizeFilters","options"].forEach(function(t){n._currentOutput[t]=e._currentOutput[t].clone()}),this._currentOutput.sizeData&&(n._currentOutput.sizeData={},utils.copy(this._currentOutput.sizeData,n._currentOutput.sizeData)),utils.copy(this._currentOutput.flags,n._currentOutput.flags)),["_global","_complexFilters"].forEach(function(t){n[t]=e[t].clone()}),n};requireInputs()(FfmpegCommand.prototype);requireAudio()(FfmpegCommand.prototype);requireVideo()(FfmpegCommand.prototype);requireVideosize()(FfmpegCommand.prototype);requireOutput()(FfmpegCommand.prototype);requireCustom()(FfmpegCommand.prototype);requireMisc()(FfmpegCommand.prototype);requireProcessor()(FfmpegCommand.prototype);requireCapabilities()(FfmpegCommand.prototype);FfmpegCommand.setFfmpegPath=function(n){new FfmpegCommand().setFfmpegPath(n)};FfmpegCommand.setFfprobePath=function(n){new FfmpegCommand().setFfprobePath(n)};FfmpegCommand.setFlvtoolPath=function(n){new FfmpegCommand().setFlvtoolPath(n)};FfmpegCommand.availableFilters=FfmpegCommand.getAvailableFilters=function(n){new FfmpegCommand().availableFilters(n)};FfmpegCommand.availableCodecs=FfmpegCommand.getAvailableCodecs=function(n){new FfmpegCommand().availableCodecs(n)};FfmpegCommand.availableFormats=FfmpegCommand.getAvailableFormats=function(n){new FfmpegCommand().availableFormats(n)};FfmpegCommand.availableEncoders=FfmpegCommand.getAvailableEncoders=function(n){new FfmpegCommand().availableEncoders(n)};requireFfprobe()(FfmpegCommand.prototype);FfmpegCommand.ffprobe=function(n){var e=new FfmpegCommand(n);e.ffprobe.apply(e,Array.prototype.slice.call(arguments,1))};requireRecipes()(FfmpegCommand.prototype);var fluentFfmpeg=fluentFfmpeg$1;const ffmpeg=getDefaultExportFromCjs(fluentFfmpeg),appPath=process.argv[1]||process.cwd(),appDir=require$$1.dirname(appPath),dragIconPaths=[require$$1.join(appDir,"..","..","..","64x64.png"),require$$1.join(process.resourcesPath,"64x64.png"),require$$1.join(process.resourcesPath,"app.asar","64x64.png"),require$$1.join(electron.app.getAppPath(),"64x64.png")],dragIconPath=dragIconPaths.find(n=>require$$0.existsSync(n))||dragIconPaths[0];electron.app.disableHardwareAcceleration();process.on("uncaughtException",n=>{console.error("Uncaught Exception:",n)});process.on("unhandledRejection",(n,e)=>{console.error("Unhandled Rejection at:",e,"reason:",n)});electron.app.disableHardwareAcceleration();let mainWindow=null,tray=null,isQuitting=!1;const isDev=process.env.NODE_ENV==="development",clipsPath="D:\\Clips\\ClipVault",thumbnailsPath=require$$1.join(electron.app.getPath("userData"),"thumbnails"),ffmpegPath=require$$1.join(process.resourcesPath,"ffmpeg","ffmpeg.exe"),ffprobePath=require$$1.join(process.resourcesPath,"ffmpeg","ffprobe.exe");require$$0.existsSync(ffmpegPath)&&(process.env.PATH=`${require$$1.dirname(ffmpegPath)}:${process.env.PATH}`,console.log("Using bundled FFmpeg:",ffmpegPath));require$$0.existsSync(ffprobePath)&&console.log("Using bundled FFprobe:",ffprobePath);console.log("Config:",{clipsPath,thumbnailsPath,userData:electron.app.getPath("userData")});const gotTheLock=electron.app.requestSingleInstanceLock();gotTheLock?electron.app.on("second-instance",()=>{console.log("Second instance detected, focusing existing window and checking backend"),mainWindow&&(mainWindow.isMinimized()&&mainWindow.restore(),mainWindow.show(),mainWindow.focus());const e=!isDev?require$$1.join(process.resourcesPath,"bin","ClipVault.exe"):require$$1.join(appDir,"..","..","..","bin","ClipVault.exe");if(require$$0.existsSync(e))try{console.log("Second instance: Spawning backend from:",e);const t=require$$0$1.spawn(e,[],{detached:!0,stdio:["ignore","ignore","ignore"]});t.unref(),console.log("Second instance: Backend spawn attempted with PID:",t.pid)}catch(t){console.error("Second instance: Failed to start backend:",t)}}):(console.log("Another instance is already running. Quitting."),electron.app.quit());electron.protocol.registerSchemesAsPrivileged([{scheme:"clipvault",privileges:{secure:!0,supportFetchAPI:!0,bypassCSP:!0,corsEnabled:!0}}]);function createTray(){console.log("Creating tray icon...");let n;require$$0.existsSync(dragIconPath)&&(n=electron.nativeImage.createFromPath(dragIconPath),n.isEmpty()&&(n=void 0)),n||(n=electron.nativeImage.createFromPath(require$$1.join(appDir,"..","renderer","favicon.ico")),n!=null&&n.isEmpty()&&(n=void 0)),tray=new electron.Tray(n||electron.nativeImage.createEmpty()),tray.setToolTip("ClipVault Editor"),tray.setContextMenu(electron.Menu.buildFromTemplate([{label:"Open ClipVault",click:()=>{mainWindow&&(mainWindow.show(),mainWindow.focus())}},{label:"Open Clips Folder",click:async()=>{const e=clipsPath;require$$0.existsSync(e)||await promises.mkdir(e,{recursive:!0}),await electron.shell.openPath(e)}},{type:"separator"},{label:"Exit",click:()=>{electron.app.quit()}}])),tray.on("click",()=>{mainWindow&&(mainWindow.isVisible()?mainWindow.hide():(mainWindow.show(),mainWindow.focus()))}),tray.on("double-click",()=>{mainWindow&&(mainWindow.show(),mainWindow.focus())}),console.log("Tray icon created")}async function createWindow(){console.log("Creating main window..."),mainWindow=new electron.BrowserWindow({width:1400,height:900,minWidth:1e3,minHeight:600,title:"ClipVault Editor",backgroundColor:"#0f0f0f",show:!0,webPreferences:{preload:isDev?require$$1.join(appDir,"..","preload","index.js"):require$$1.join(process.resourcesPath,"app.asar","dist","preload","index.js"),contextIsolation:!0,nodeIntegration:!1,sandbox:!1,webSecurity:!1},titleBarStyle:"hiddenInset",...process.platform==="win32"?{titleBarOverlay:{color:"#0f0f0f",symbolColor:"#ffffff"}}:{}}),console.log("Main window created, loading content...");try{isDev?(await mainWindow.loadURL("http://localhost:5173"),console.log("Loaded dev URL, opening devtools..."),mainWindow.webContents.openDevTools()):(await mainWindow.loadFile(isDev?require$$1.join(appDir,"..","renderer","index.html"):require$$1.join(process.resourcesPath,"app.asar","dist","renderer","index.html")),console.log("Loaded production HTML file"))}catch(n){console.error("Error loading window content:",n)}electron.Menu.setApplicationMenu(null),mainWindow.webContents.on("crashed",(n,e)=>{console.error("Window crashed!",{killed:e}),e||mainWindow==null||mainWindow.reload()}),electron.app.on("gpu-process-crashed",(n,e)=>{console.error("GPU process crashed!",{killed:e})}),mainWindow.once("ready-to-show",()=>{console.log("Window ready to show, showing now..."),mainWindow==null||mainWindow.show(),mainWindow==null||mainWindow.focus()}),setTimeout(()=>{mainWindow&&!mainWindow.isVisible()&&(console.log("Fallback: forcing window to show after timeout"),mainWindow.show(),mainWindow.focus())},2e3),mainWindow.on("close",n=>{isQuitting||(n.preventDefault(),console.log("Minimizing to tray instead of closing"),mainWindow==null||mainWindow.hide())}),mainWindow.on("page-title-updated",n=>{n.preventDefault()}),mainWindow.on("closed",()=>{mainWindow=null}),mainWindow.webContents.on("before-input-event",(n,e)=>{e.key==="F12"&&(mainWindow==null||mainWindow.webContents.toggleDevTools(),n.preventDefault())})}electron.ipcMain.handle("clips:getList",async()=>{try{if(!require$$0.existsSync(clipsPath))return await promises.mkdir(clipsPath,{recursive:!0}),[];const n=await promises.readdir(clipsPath);return(await Promise.all(n.filter(t=>t.endsWith(".mp4")).map(async t=>{const i=require$$1.join(clipsPath,t),p=await promises.stat(i),o=i.replace(".mp4",".clipvault.json");let f=null;try{if(require$$0.existsSync(o)){const a=await promises.readFile(o,"utf-8");f=JSON.parse(a)}}catch(a){console.error("Failed to read metadata:",a)}return{id:t.replace(".mp4",""),filename:t,path:i,size:p.size,createdAt:p.birthtime.toISOString(),modifiedAt:p.mtime.toISOString(),metadata:f}}))).sort((t,i)=>new Date(i.createdAt).getTime()-new Date(t.createdAt).getTime())}catch(n){throw console.error("Failed to get clips list:",n),n}});electron.ipcMain.handle("clips:saveMetadata",async(n,e,t)=>{try{const i=require$$1.join(clipsPath,`${e}.clipvault.json`);return await promises.writeFile(i,JSON.stringify(t,null,2),"utf-8"),!0}catch(i){throw console.error("Failed to save metadata:",i),i}});electron.ipcMain.handle("clips:getMetadata",async(n,e)=>{try{const t=require$$1.join(clipsPath,`${e}.clipvault.json`);if(!require$$0.existsSync(t))return null;const i=await promises.readFile(t,"utf-8");return JSON.parse(i)}catch(t){return console.error("Failed to get metadata:",t),null}});electron.ipcMain.handle("system:openFolder",async()=>{await electron.shell.openPath(clipsPath)});electron.ipcMain.handle("dialog:save",async(n,e)=>mainWindow?await electron.dialog.showSaveDialog(mainWindow,e):null);electron.ipcMain.handle("clips:generateThumbnail",async(n,e,t)=>{try{require$$0.existsSync(thumbnailsPath)||await promises.mkdir(thumbnailsPath,{recursive:!0});const i=`${e}.jpg`,p=require$$1.join(thumbnailsPath,i);return require$$0.existsSync(p)?`clipvault://thumb/${encodeURIComponent(i)}`:new Promise((o,f)=>{ffmpeg(t).screenshots({timestamps:["10%"],filename:i,folder:thumbnailsPath,size:"480x270"}).on("end",()=>{o(`clipvault://thumb/${encodeURIComponent(i)}`)}).on("error",a=>{console.error("FFmpeg error:",a),f(a)})})}catch(i){throw console.error("Failed to generate thumbnail:",i),i}});electron.ipcMain.handle("video:getFileUrl",async(n,e)=>{try{const t=require$$1.join(clipsPath,e);if(!require$$0.existsSync(t))return console.error("Video file not found:",t),{success:!1,error:"File not found"};const i=`file:///${t.replace(/\\/g,"/")}`;return console.log("Returning video file URL:",i),{success:!0,url:i,path:t}}catch(t){return console.error("Error getting video file URL:",t),{success:!1,error:String(t)}}});electron.ipcMain.handle("clips:getVideoMetadata",async(_,videoPath)=>{try{return new Promise((resolve,reject)=>{ffmpeg.ffprobe(videoPath,(err,metadata)=>{if(err){reject(err);return}const videoStream=metadata.streams.find(n=>n.codec_type==="video"),audioStreams=metadata.streams.filter(n=>n.codec_type==="audio");resolve({duration:metadata.format.duration||0,width:(videoStream==null?void 0:videoStream.width)||0,height:(videoStream==null?void 0:videoStream.height)||0,fps:videoStream?eval(videoStream.r_frame_rate||"0"):0,bitrate:metadata.format.bit_rate||0,size:metadata.format.size||0,format:metadata.format.format_name||"",videoCodec:(videoStream==null?void 0:videoStream.codec_name)||"",audioTracks:audioStreams.length})})})}catch(n){throw console.error("Failed to get video metadata:",n),n}});let exportPreviewWindow=null;function createExportPreviewWindow(n){exportPreviewWindow&&!exportPreviewWindow.isDestroyed()&&exportPreviewWindow.close(),exportPreviewWindow=new electron.BrowserWindow({width:600,height:500,alwaysOnTop:!0,modal:!1,resizable:!1,title:"Export Complete",backgroundColor:"#1a1a1a",webPreferences:{contextIsolation:!1,nodeIntegration:!0,webSecurity:!1}}),exportPreviewWindow.setMenu(null),exportPreviewWindow.webContents.on("crashed",()=>{console.error("Preview window crashed"),exportPreviewWindow==null||exportPreviewWindow.close(),exportPreviewWindow=null});const e=n.split("\\").pop()||"",p=`<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <style>
    * { box-sizing: border-box; }
    body { margin: 0; padding: 20px; background: #1a1a1a; color: white; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; overflow: hidden; }
    video { width: 100%; border-radius: 8px; max-height: 320px; object-fit: contain; background: #000; }
    .drag-hint { text-align: center; padding: 15px; background: #2a2a2a; border-radius: 8px; margin-top: 10px; cursor: grab; user-select: none; }
    .drag-hint:active { cursor: grabbing; }
    .drag-hint h3 { margin: 0 0 8px 0; font-size: 16px; color: #4ade80; }
    .drag-hint p { margin: 0; font-size: 13px; color: #aaa; }
    .timer { position: absolute; top: 10px; right: 10px; font-size: 12px; color: #666; }
    .file-icon { font-size: 24px; margin-bottom: 8px; }
    .actions { display: flex; gap: 10px; margin-top: 10px; }
    .btn { flex: 1; padding: 10px; background: #3a3a3a; border: none; border-radius: 6px; color: white; cursor: pointer; font-size: 13px; }
    .btn:hover { background: #4a4a4a; }
    .btn-primary { background: #4ade80; color: #0f0f0f; }
    .btn-primary:hover { background: #22c55e; }
  </style>
</head>
<body>
  <div class="timer" id="timer">Closing in 30s</div>
  <video src="${`clipvault://${n.includes("exported-clips")?"exported":"clip"}/${encodeURIComponent(e)}`}" controls autoplay></video>
  <div class="drag-hint" id="dragHint" draggable="true">
    <div class="file-icon"></div>
    <h3>Export Complete!</h3>
    <p>Drag from here to share the file anywhere</p>
  </div>
  <div class="actions">
    <button class="btn" onclick="copyPath()">Copy Path</button>
    <button class="btn btn-primary" onclick="openFolder()">Open Folder</button>
  </div>
  <script>
    const { ipcRenderer } = require('electron');
    const filePath = '${n.replace(/\\/g,"\\\\")}';
    let timeLeft = 30;
    const timerEl = document.getElementById('timer');
    const interval = setInterval(() => {
      timeLeft--;
      timerEl.textContent = 'Closing in ' + timeLeft + 's';
      if (timeLeft <= 0) {
        clearInterval(interval);
        window.close();
      }
    }, 1000);
    
    // Handle drag start - send IPC to main process for native drag
    const dragHint = document.getElementById('dragHint');
    dragHint.addEventListener('dragstart', (e) => {
      e.preventDefault();
      // Send IPC to main process to initiate native drag
      ipcRenderer.send('export:startDrag', filePath);
    });
    
    function copyPath() {
      navigator.clipboard.writeText(filePath);
      const btn = event.target;
      const originalText = btn.textContent;
      btn.textContent = 'Copied!';
      setTimeout(() => btn.textContent = originalText, 1500);
    }
    
    function openFolder() {
      ipcRenderer.send('export:openFolder', filePath);
    }
  <\/script>
</body>
</html>`;exportPreviewWindow.loadURL("data:text/html;charset=utf-8,"+encodeURIComponent(p));const o=setTimeout(()=>{exportPreviewWindow&&!exportPreviewWindow.isDestroyed()&&exportPreviewWindow.close()},3e4);exportPreviewWindow.on("closed",()=>{clearTimeout(o),exportPreviewWindow=null}),exportPreviewWindow.webContents.on("ipc-message",(f,a,d)=>{if(a==="export:startDrag"){console.log("Starting native drag for:",d);try{let y;require$$0.existsSync(dragIconPath)?(y=electron.nativeImage.createFromPath(dragIconPath),console.log("Drag icon loaded from:",dragIconPath)):console.warn("Drag icon not found at:",dragIconPath),exportPreviewWindow==null||exportPreviewWindow.webContents.startDrag({file:d,icon:y||electron.nativeImage.createEmpty()})}catch(y){console.error("Error starting drag:",y)}}else if(a==="export:openFolder"){const y=require$$1.dirname(d);electron.shell.openPath(y)}})}electron.ipcMain.handle("export:showPreview",async(n,e)=>(createExportPreviewWindow(e),{success:!0}));electron.ipcMain.handle("audio:extractTracks",async(n,e,t)=>{try{const i=require$$1.join(thumbnailsPath,"audio");require$$0.existsSync(i)||await promises.mkdir(i,{recursive:!0});const p=require$$1.join(i,`${e}_track1.m4a`),o=require$$1.join(i,`${e}_track2.m4a`),f={},a=require$$0.existsSync(p),d=require$$0.existsSync(o);if(a&&(f.track1=`clipvault://audio/${encodeURIComponent(`${e}_track1.m4a`)}`),d&&(f.track2=`clipvault://audio/${encodeURIComponent(`${e}_track2.m4a`)}`),a&&d)return f;const g=(await new Promise((P,v)=>{ffmpeg.ffprobe(t,(A,x)=>{A?v(A):P(x)})})).streams.filter(P=>P.codec_type==="audio");return!a&&g.length>=1&&(await new Promise((P,v)=>{ffmpeg(t).outputOptions(["-map 0:a:0","-c:a aac","-b:a 128k"]).save(p).on("end",()=>P()).on("error",A=>v(A))}),f.track1=`clipvault://audio/${encodeURIComponent(`${e}_track1.m4a`)}`),!d&&g.length>=2&&(await new Promise((P,v)=>{ffmpeg(t).outputOptions(["-map 0:a:1","-c:a aac","-b:a 128k"]).save(o).on("end",()=>P()).on("error",A=>v(A))}),f.track2=`clipvault://audio/${encodeURIComponent(`${e}_track2.m4a`)}`),f}catch(i){return console.error("Failed to extract audio tracks:",i),{error:String(i)}}});electron.ipcMain.handle("editor:exportClip",async(n,e)=>{try{const{clipPath:t,exportFilename:i,trimStart:p,trimEnd:o,audioTrack1:f,audioTrack2:a,audioTrack1Volume:d,audioTrack2Volume:y}=e,g=o-p,P=d??1,v=y??1,A=require$$1.join(clipsPath,"exported-clips");require$$0.existsSync(A)||await promises.mkdir(A,{recursive:!0});const x=require$$1.join(A,i);return new Promise((q,w)=>{const C=ffmpeg(t).seekInput(p).duration(g).videoCodec("copy");if(f&&a){const b=`[0:a:0]volume=${P}[a0];[0:a:1]volume=${v}[a1];[a0][a1]amix=inputs=2:duration=first:dropout_transition=3[aout]`;C.outputOptions(["-map 0:v:0","-filter_complex",b,"-map","[aout]","-c:a aac","-b:a 128k","-ac 2"])}else f?P<1?C.outputOptions(["-map 0:v:0","-map 0:a:0","-filter:a:0",`volume=${P}`]):C.outputOptions(["-map 0:v:0","-map 0:a:0"]):a?v<1?C.outputOptions(["-map 0:v:0","-map 0:a:1","-filter:a:0",`volume=${v}`]):C.outputOptions(["-map 0:v:0","-map 0:a:1"]):C.noAudio();C.on("progress",b=>{mainWindow&&b.percent&&mainWindow.webContents.send("export:progress",{percent:b.percent})}).on("end",()=>{q({success:!0,filePath:x})}).on("error",b=>{console.error("Export error:",b),w(b)}).save(x)})}catch(t){throw console.error("Failed to export clip:",t),t}});electron.app.whenReady().then(async()=>{console.log("App is ready, creating window..."),electron.protocol.registerFileProtocol("clipvault",(t,i)=>{try{console.log("Protocol handler called:",t.url);const p=new URL(t.url),o=p.host,f=p.pathname;if(console.log("Parsed URL:",{host:o,pathname:f}),!o||!f){console.error("Invalid URL format:",{host:o,pathname:f}),i({error:-2});return}const a=o,d=f.substring(1),y=decodeURIComponent(d);console.log("Processing file:",{type:a,filename:y});let g;if(a==="clip")g=clipsPath;else if(a==="thumb")g=thumbnailsPath;else if(a==="audio")g=require$$1.join(thumbnailsPath,"audio");else if(a==="exported")g=require$$1.join(clipsPath,"exported-clips");else{console.error("Unknown resource type:",a),i({error:-2});return}const P=require$$1.join(g,y);if(console.log("Full file path:",P),!require$$0.existsSync(P)){console.error("File not found:",P),i({error:-6});return}i({path:P})}catch(p){console.error("Protocol handler error:",p),i({error:-2})}}),createTray(),await createWindow().catch(t=>{console.error("Failed to create window:",t)});const n=!isDev,e=n?require$$1.join(process.resourcesPath,"bin","ClipVault.exe"):require$$1.join(appDir,"..","..","..","bin","ClipVault.exe");if(n?require$$1.join(process.resourcesPath,"bin","clipvault.log"):require$$1.join(appDir,"..","..","..","bin","clipvault.log"),console.log("Attempting to start backend..."),require$$0.existsSync(e))try{console.log("Spawning backend from:",e),console.log("process.resourcesPath:",process.resourcesPath);const t=require$$0$1.spawn(e,[],{detached:!0,stdio:["ignore","ignore","ignore"]});t.on("error",i=>{console.error("Backend spawn error:",i)}),t.on("exit",(i,p)=>{console.log(`Backend exited with code ${i} and signal ${p}`)}),console.log("Backend spawned with PID:",t.pid),t.unref(),setTimeout(()=>{try{const p=require$$0$1.execSync('tasklist /NH /FO CSV /FI "IMAGENAME eq ClipVault.exe"',{encoding:"utf-8",stdio:["pipe","pipe","ignore"]}).includes("ClipVault.exe");console.log("Backend verification after spawn:",p?"running":"not running");const o=n?require$$1.join(process.resourcesPath,"bin","clipvault.log"):require$$1.join(appDir,"..","..","..","bin","clipvault.log");require$$0.existsSync(o)?console.log("Backend log file exists:",o):console.warn("Backend log file not found - spawn may have failed silently")}catch(i){console.log("Could not verify backend status:",i)}},2e3)}catch(t){console.error("Failed to start backend:",t)}else console.warn("Backend executable not found:",e);electron.app.on("activate",()=>{electron.BrowserWindow.getAllWindows().length===0&&createWindow()})});electron.app.on("window-all-closed",()=>{process.platform!=="darwin"&&(tray||electron.app.quit())});electron.app.on("before-quit",n=>{console.log("App is quitting..."),isQuitting=!0,tray&&(tray.destroy(),tray=null)});electron.app.on("will-quit",()=>{isQuitting=!0});
//# sourceMappingURL=main.js.map
