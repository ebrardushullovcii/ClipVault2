"use strict";const electron=require("electron"),require$$1=require("path"),promises=require("fs/promises"),require$$0=require("fs"),require$$1$2=require("util"),require$$2$1=require("events"),require$$0$1=require("child_process"),require$$1$1=require("os"),require$$2=require("stream");var commonjsGlobal=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function getDefaultExportFromCjs(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}var utils$2={exports:{}},windows,hasRequiredWindows;function requireWindows(){if(hasRequiredWindows)return windows;hasRequiredWindows=1,windows=i,i.sync=d;var n=require$$0;function e(o,p){var a=p.pathExt!==void 0?p.pathExt:process.env.PATHEXT;if(!a||(a=a.split(";"),a.indexOf("")!==-1))return!0;for(var f=0;f<a.length;f++){var y=a[f].toLowerCase();if(y&&o.substr(-y.length).toLowerCase()===y)return!0}return!1}function t(o,p,a){return!o.isSymbolicLink()&&!o.isFile()?!1:e(p,a)}function i(o,p,a){n.stat(o,function(f,y){a(f,f?!1:t(y,o,p))})}function d(o,p){return t(n.statSync(o),o,p)}return windows}var mode,hasRequiredMode;function requireMode(){if(hasRequiredMode)return mode;hasRequiredMode=1,mode=e,e.sync=t;var n=require$$0;function e(o,p,a){n.stat(o,function(f,y){a(f,f?!1:i(y,p))})}function t(o,p){return i(n.statSync(o),p)}function i(o,p){return o.isFile()&&d(o,p)}function d(o,p){var a=o.mode,f=o.uid,y=o.gid,x=p.uid!==void 0?p.uid:process.getuid&&process.getuid(),b=p.gid!==void 0?p.gid:process.getgid&&process.getgid(),v=parseInt("100",8),A=parseInt("010",8),F=parseInt("001",8),E=v|A,g=a&F||a&A&&y===b||a&v&&f===x||a&E&&x===0;return g}return mode}var core;process.platform==="win32"||commonjsGlobal.TESTING_WINDOWS?core=requireWindows():core=requireMode();var isexe_1=isexe$1;isexe$1.sync=sync;function isexe$1(n,e,t){if(typeof e=="function"&&(t=e,e={}),!t){if(typeof Promise!="function")throw new TypeError("callback not provided");return new Promise(function(i,d){isexe$1(n,e||{},function(o,p){o?d(o):i(p)})})}core(n,e||{},function(i,d){i&&(i.code==="EACCES"||e&&e.ignoreErrors)&&(i=null,d=!1),t(i,d)})}function sync(n,e){try{return core.sync(n,e||{})}catch(t){if(e&&e.ignoreErrors||t.code==="EACCES")return!1;throw t}}var which_1=which$1;which$1.sync=whichSync;var isWindows$1=process.platform==="win32"||process.env.OSTYPE==="cygwin"||process.env.OSTYPE==="msys",path$1=require$$1,COLON=isWindows$1?";":":",isexe=isexe_1;function getNotFoundError(n){var e=new Error("not found: "+n);return e.code="ENOENT",e}function getPathInfo(n,e){var t=e.colon||COLON,i=e.path||process.env.PATH||"",d=[""];i=i.split(t);var o="";return isWindows$1&&(i.unshift(process.cwd()),o=e.pathExt||process.env.PATHEXT||".EXE;.CMD;.BAT;.COM",d=o.split(t),n.indexOf(".")!==-1&&d[0]!==""&&d.unshift("")),(n.match(/\//)||isWindows$1&&n.match(/\\/))&&(i=[""]),{env:i,ext:d,extExe:o}}function which$1(n,e,t){typeof e=="function"&&(t=e,e={});var i=getPathInfo(n,e),d=i.env,o=i.ext,p=i.extExe,a=[];(function f(y,x){if(y===x)return e.all&&a.length?t(null,a):t(getNotFoundError(n));var b=d[y];b.charAt(0)==='"'&&b.slice(-1)==='"'&&(b=b.slice(1,-1));var v=path$1.join(b,n);!b&&/^\.[\\\/]/.test(n)&&(v=n.slice(0,2)+v),function A(F,E){if(F===E)return f(y+1,x);var g=o[F];isexe(v+g,{pathExt:p},function(C,q){if(!C&&q)if(e.all)a.push(v+g);else return t(null,v+g);return A(F+1,E)})}(0,o.length)})(0,d.length)}function whichSync(n,e){e=e||{};for(var t=getPathInfo(n,e),i=t.env,d=t.ext,o=t.extExe,p=[],a=0,f=i.length;a<f;a++){var y=i[a];y.charAt(0)==='"'&&y.slice(-1)==='"'&&(y=y.slice(1,-1));var x=path$1.join(y,n);!y&&/^\.[\\\/]/.test(n)&&(x=n.slice(0,2)+x);for(var b=0,v=d.length;b<v;b++){var A=x+d[b],F;try{if(F=isexe.sync(A,{pathExt:o}),F)if(e.all)p.push(A);else return A}catch{}}}if(e.all&&p.length)return p;if(e.nothrow)return null;throw getNotFoundError(n)}require$$0$1.exec;var isWindows=require$$1$1.platform().match(/win(32|64)/),which=which_1,nlRegexp=/\r\n|\r|\n/g,streamRegexp=/^\[?(.*?)\]?$/,filterEscapeRegexp=/[,]/,whichCache={};function parseProgressLine(n){var e={};n=n.replace(/=\s+/g,"=").trim();for(var t=n.split(" "),i=0;i<t.length;i++){var d=t[i].split("=",2),o=d[0],p=d[1];if(typeof p>"u")return null;e[o]=p}return e}var utils$1=utils$2.exports={isWindows,streamRegexp,copy:function(n,e){Object.keys(n).forEach(function(t){e[t]=n[t]})},args:function(){var n=[],e=function(){arguments.length===1&&Array.isArray(arguments[0])?n=n.concat(arguments[0]):n=n.concat([].slice.call(arguments))};return e.clear=function(){n=[]},e.get=function(){return n},e.find=function(t,i){var d=n.indexOf(t);if(d!==-1)return n.slice(d+1,d+1+(i||0))},e.remove=function(t,i){var d=n.indexOf(t);d!==-1&&n.splice(d,(i||0)+1)},e.clone=function(){var t=utils$1.args();return t(n),t},e},makeFilterStrings:function(n){return n.map(function(e){if(typeof e=="string")return e;var t="";return Array.isArray(e.inputs)?t+=e.inputs.map(function(i){return i.replace(streamRegexp,"[$1]")}).join(""):typeof e.inputs=="string"&&(t+=e.inputs.replace(streamRegexp,"[$1]")),t+=e.filter,e.options&&(typeof e.options=="string"||typeof e.options=="number"?t+="="+e.options:Array.isArray(e.options)?t+="="+e.options.map(function(i){return typeof i=="string"&&i.match(filterEscapeRegexp)?"'"+i+"'":i}).join(":"):Object.keys(e.options).length&&(t+="="+Object.keys(e.options).map(function(i){var d=e.options[i];return typeof d=="string"&&d.match(filterEscapeRegexp)&&(d="'"+d+"'"),i+"="+d}).join(":"))),Array.isArray(e.outputs)?t+=e.outputs.map(function(i){return i.replace(streamRegexp,"[$1]")}).join(""):typeof e.outputs=="string"&&(t+=e.outputs.replace(streamRegexp,"[$1]")),t})},which:function(n,e){if(n in whichCache)return e(null,whichCache[n]);which(n,function(t,i){if(t)return e(null,whichCache[n]="");e(null,whichCache[n]=i)})},timemarkToSeconds:function(n){if(typeof n=="number")return n;if(n.indexOf(":")===-1&&n.indexOf(".")>=0)return Number(n);var e=n.split(":"),t=Number(e.pop());return e.length&&(t+=Number(e.pop())*60),e.length&&(t+=Number(e.pop())*3600),t},extractCodecData:function(n,e,t){var i=/Input #[0-9]+, ([^ ]+),/,d=/Duration\: ([^,]+)/,o=/Audio\: (.*)/,p=/Video\: (.*)/;"inputStack"in t||(t.inputStack=[],t.inputIndex=-1,t.inInput=!1);var a=t.inputStack,f=t.inputIndex,y=t.inInput,x,b,v,A;if(x=e.match(i))y=t.inInput=!0,f=t.inputIndex=t.inputIndex+1,a[f]={format:x[1],audio:"",video:"",duration:""};else if(y&&(b=e.match(d)))a[f].duration=b[1];else if(y&&(v=e.match(o)))v=v[1].split(", "),a[f].audio=v[0],a[f].audio_details=v;else if(y&&(A=e.match(p)))A=A[1].split(", "),a[f].video=A[0],a[f].video_details=A;else if(/Output #\d+/.test(e))y=t.inInput=!1;else if(/Stream mapping:|Press (\[q\]|ctrl-c) to stop/.test(e))return n.emit.apply(n,["codecData"].concat(a)),!0;return!1},extractProgress:function(n,e){var t=parseProgressLine(e);if(t){var i={frames:parseInt(t.frame,10),currentFps:parseInt(t.fps,10),currentKbps:t.bitrate?parseFloat(t.bitrate.replace("kbits/s","")):0,targetSize:parseInt(t.size||t.Lsize,10),timemark:t.time};if(n._ffprobeData&&n._ffprobeData.format&&n._ffprobeData.format.duration){var d=Number(n._ffprobeData.format.duration);isNaN(d)||(i.percent=utils$1.timemarkToSeconds(i.timemark)/d*100)}n.emit("progress",i)}},extractError:function(n){return n.split(nlRegexp).reduce(function(e,t){return t.charAt(0)===" "||t.charAt(0)==="["?[]:(e.push(t),e)},[]).join(`
`)},linesRing:function(n){var e=[],t=[],i=null,d=!1,o=n-1;function p(a){e.forEach(function(f){f(a)})}return{callback:function(a){t.forEach(function(f){a(f)}),e.push(a)},append:function(a){if(!d&&(a instanceof Buffer&&(a=""+a),!(!a||a.length===0))){var f=a.split(nlRegexp);f.length===1?i!==null?i=i+f.shift():i=f.shift():(i!==null&&(i=i+f.shift(),p(i),t.push(i)),i=f.pop(),f.forEach(function(y){p(y),t.push(y)}),o>-1&&t.length>o&&t.splice(0,t.length-o))}},get:function(){return i!==null?t.concat([i]).join(`
`):t.join(`
`)},close:function(){d||(i!==null&&(p(i),t.push(i),o>-1&&t.length>o&&t.shift(),i=null),d=!0)}}}},utilsExports=utils$2.exports,inputs,hasRequiredInputs;function requireInputs(){if(hasRequiredInputs)return inputs;hasRequiredInputs=1;var n=utilsExports;return inputs=function(e){e.mergeAdd=e.addInput=e.input=function(t){var i=!1,d=!1;if(typeof t!="string"){if(!("readable"in t)||!t.readable)throw new Error("Invalid input");var o=this._inputs.some(function(a){return a.isStream});if(o)throw new Error("Only one input stream is supported");d=!0,t.pause()}else{var p=t.match(/^([a-z]{2,}):/i);i=!p||p[0]==="file"}return this._inputs.push(this._currentInput={source:t,isFile:i,isStream:d,options:n.args()}),this},e.withInputFormat=e.inputFormat=e.fromFormat=function(t){if(!this._currentInput)throw new Error("No input specified");return this._currentInput.options("-f",t),this},e.withInputFps=e.withInputFPS=e.withFpsInput=e.withFPSInput=e.inputFPS=e.inputFps=e.fpsInput=e.FPSInput=function(t){if(!this._currentInput)throw new Error("No input specified");return this._currentInput.options("-r",t),this},e.nativeFramerate=e.withNativeFramerate=e.native=function(){if(!this._currentInput)throw new Error("No input specified");return this._currentInput.options("-re"),this},e.setStartTime=e.seekInput=function(t){if(!this._currentInput)throw new Error("No input specified");return this._currentInput.options("-ss",t),this},e.loop=function(t){if(!this._currentInput)throw new Error("No input specified");return this._currentInput.options("-loop","1"),typeof t<"u"&&this.duration(t),this}},inputs}var audio,hasRequiredAudio;function requireAudio(){if(hasRequiredAudio)return audio;hasRequiredAudio=1;var n=utilsExports;return audio=function(e){e.withNoAudio=e.noAudio=function(){return this._currentOutput.audio.clear(),this._currentOutput.audioFilters.clear(),this._currentOutput.audio("-an"),this},e.withAudioCodec=e.audioCodec=function(t){return this._currentOutput.audio("-acodec",t),this},e.withAudioBitrate=e.audioBitrate=function(t){return this._currentOutput.audio("-b:a",(""+t).replace(/k?$/,"k")),this},e.withAudioChannels=e.audioChannels=function(t){return this._currentOutput.audio("-ac",t),this},e.withAudioFrequency=e.audioFrequency=function(t){return this._currentOutput.audio("-ar",t),this},e.withAudioQuality=e.audioQuality=function(t){return this._currentOutput.audio("-aq",t),this},e.withAudioFilter=e.withAudioFilters=e.audioFilter=e.audioFilters=function(t){return arguments.length>1&&(t=[].slice.call(arguments)),Array.isArray(t)||(t=[t]),this._currentOutput.audioFilters(n.makeFilterStrings(t)),this}},audio}var video,hasRequiredVideo;function requireVideo(){if(hasRequiredVideo)return video;hasRequiredVideo=1;var n=utilsExports;return video=function(e){e.withNoVideo=e.noVideo=function(){return this._currentOutput.video.clear(),this._currentOutput.videoFilters.clear(),this._currentOutput.video("-vn"),this},e.withVideoCodec=e.videoCodec=function(t){return this._currentOutput.video("-vcodec",t),this},e.withVideoBitrate=e.videoBitrate=function(t,i){return t=(""+t).replace(/k?$/,"k"),this._currentOutput.video("-b:v",t),i&&this._currentOutput.video("-maxrate",t,"-minrate",t,"-bufsize","3M"),this},e.withVideoFilter=e.withVideoFilters=e.videoFilter=e.videoFilters=function(t){return arguments.length>1&&(t=[].slice.call(arguments)),Array.isArray(t)||(t=[t]),this._currentOutput.videoFilters(n.makeFilterStrings(t)),this},e.withOutputFps=e.withOutputFPS=e.withFpsOutput=e.withFPSOutput=e.withFps=e.withFPS=e.outputFPS=e.outputFps=e.fpsOutput=e.FPSOutput=e.fps=e.FPS=function(t){return this._currentOutput.video("-r",t),this},e.takeFrames=e.withFrames=e.frames=function(t){return this._currentOutput.video("-vframes",t),this}},video}var videosize,hasRequiredVideosize;function requireVideosize(){if(hasRequiredVideosize)return videosize;hasRequiredVideosize=1;function n(t,i,d,o){return[{filter:"scale",options:{w:"if(gt(a,"+d+"),"+t+",trunc("+i+"*a/2)*2)",h:"if(lt(a,"+d+"),"+i+",trunc("+t+"/a/2)*2)"}},{filter:"pad",options:{w:t,h:i,x:"if(gt(a,"+d+"),0,("+t+"-iw)/2)",y:"if(lt(a,"+d+"),0,("+i+"-ih)/2)",color:o}}]}function e(t,i,d){var o=t.sizeData=t.sizeData||{};if(o[i]=d,!("size"in o))return[];var p=o.size.match(/([0-9]+)x([0-9]+)/),a=o.size.match(/([0-9]+)x\?/),f=o.size.match(/\?x([0-9]+)/),y=o.size.match(/\b([0-9]{1,3})%/),x,b,v;if(y){var A=Number(y[1])/100;return[{filter:"scale",options:{w:"trunc(iw*"+A+"/2)*2",h:"trunc(ih*"+A+"/2)*2"}}]}else{if(p)return x=Math.round(Number(p[1])/2)*2,b=Math.round(Number(p[2])/2)*2,v=x/b,o.pad?n(x,b,v,o.pad):[{filter:"scale",options:{w:x,h:b}}];if(a||f)return"aspect"in o?(x=a?a[1]:Math.round(Number(f[1])*o.aspect),b=f?f[1]:Math.round(Number(a[1])/o.aspect),x=Math.round(x/2)*2,b=Math.round(b/2)*2,o.pad?n(x,b,o.aspect,o.pad):[{filter:"scale",options:{w:x,h:b}}]):a?[{filter:"scale",options:{w:Math.round(Number(a[1])/2)*2,h:"trunc(ow/a/2)*2"}}]:[{filter:"scale",options:{w:"trunc(oh*a/2)*2",h:Math.round(Number(f[1])/2)*2}}];throw new Error("Invalid size specified: "+o.size)}}return videosize=function(t){t.keepPixelAspect=t.keepDisplayAspect=t.keepDisplayAspectRatio=t.keepDAR=function(){return this.videoFilters([{filter:"scale",options:{w:"if(gt(sar,1),iw*sar,iw)",h:"if(lt(sar,1),ih/sar,ih)"}},{filter:"setsar",options:"1"}])},t.withSize=t.setSize=t.size=function(i){var d=e(this._currentOutput,"size",i);return this._currentOutput.sizeFilters.clear(),this._currentOutput.sizeFilters(d),this},t.withAspect=t.withAspectRatio=t.setAspect=t.setAspectRatio=t.aspect=t.aspectRatio=function(i){var d=Number(i);if(isNaN(d)){var o=i.match(/^(\d+):(\d+)$/);if(o)d=Number(o[1])/Number(o[2]);else throw new Error("Invalid aspect ratio: "+i)}var p=e(this._currentOutput,"aspect",d);return this._currentOutput.sizeFilters.clear(),this._currentOutput.sizeFilters(p),this},t.applyAutopadding=t.applyAutoPadding=t.applyAutopad=t.applyAutoPad=t.withAutopadding=t.withAutoPadding=t.withAutopad=t.withAutoPad=t.autoPad=t.autopad=function(i,d){typeof i=="string"&&(d=i,i=!0),typeof i>"u"&&(i=!0);var o=e(this._currentOutput,"pad",i?d||"black":!1);return this._currentOutput.sizeFilters.clear(),this._currentOutput.sizeFilters(o),this}},videosize}var output,hasRequiredOutput;function requireOutput(){if(hasRequiredOutput)return output;hasRequiredOutput=1;var n=utilsExports;return output=function(e){e.addOutput=e.output=function(t,i){var d=!1;if(!t&&this._currentOutput)throw new Error("Invalid output");if(t&&typeof t!="string"){if(!("writable"in t)||!t.writable)throw new Error("Invalid output")}else if(typeof t=="string"){var o=t.match(/^([a-z]{2,}):/i);d=!o||o[0]==="file"}if(t&&!("target"in this._currentOutput))this._currentOutput.target=t,this._currentOutput.isFile=d,this._currentOutput.pipeopts=i||{};else{if(t&&typeof t!="string"){var p=this._outputs.some(function(f){return typeof f.target!="string"});if(p)throw new Error("Only one output stream is supported")}this._outputs.push(this._currentOutput={target:t,isFile:d,flags:{},pipeopts:i||{}});var a=this;["audio","audioFilters","video","videoFilters","sizeFilters","options"].forEach(function(f){a._currentOutput[f]=n.args()}),t||delete this._currentOutput.target}return this},e.seekOutput=e.seek=function(t){return this._currentOutput.options("-ss",t),this},e.withDuration=e.setDuration=e.duration=function(t){return this._currentOutput.options("-t",t),this},e.toFormat=e.withOutputFormat=e.outputFormat=e.format=function(t){return this._currentOutput.options("-f",t),this},e.map=function(t){return this._currentOutput.options("-map",t.replace(n.streamRegexp,"[$1]")),this},e.updateFlvMetadata=e.flvmeta=function(){return this._currentOutput.flags.flvmeta=!0,this}},output}var custom,hasRequiredCustom;function requireCustom(){if(hasRequiredCustom)return custom;hasRequiredCustom=1;var n=utilsExports;return custom=function(e){e.addInputOption=e.addInputOptions=e.withInputOption=e.withInputOptions=e.inputOption=e.inputOptions=function(t){if(!this._currentInput)throw new Error("No input specified");var i=!0;return arguments.length>1&&(t=[].slice.call(arguments),i=!1),Array.isArray(t)||(t=[t]),this._currentInput.options(t.reduce(function(d,o){var p=String(o).split(" ");return i&&p.length===2?d.push(p[0],p[1]):d.push(o),d},[])),this},e.addOutputOption=e.addOutputOptions=e.addOption=e.addOptions=e.withOutputOption=e.withOutputOptions=e.withOption=e.withOptions=e.outputOption=e.outputOptions=function(t){var i=!0;return arguments.length>1&&(t=[].slice.call(arguments),i=!1),Array.isArray(t)||(t=[t]),this._currentOutput.options(t.reduce(function(d,o){var p=String(o).split(" ");return i&&p.length===2?d.push(p[0],p[1]):d.push(o),d},[])),this},e.filterGraph=e.complexFilter=function(t,i){if(this._complexFilters.clear(),Array.isArray(t)||(t=[t]),this._complexFilters("-filter_complex",n.makeFilterStrings(t).join(";")),Array.isArray(i)){var d=this;i.forEach(function(o){d._complexFilters("-map",o.replace(n.streamRegexp,"[$1]"))})}else typeof i=="string"&&this._complexFilters("-map",i.replace(n.streamRegexp,"[$1]"));return this}},custom}function commonjsRequire(n){throw new Error('Could not dynamically require "'+n+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var misc,hasRequiredMisc;function requireMisc(){if(hasRequiredMisc)return misc;hasRequiredMisc=1;var n=require$$1;return misc=function(e){e.usingPreset=e.preset=function(t){if(typeof t=="function")t(this);else try{var i=n.join(this.options.presets,t),d=commonjsRequire(i);if(typeof d.load=="function")d.load(this);else throw new Error("preset "+i+" has no load() function")}catch(o){throw new Error("preset "+i+" could not be loaded: "+o.message)}return this}},misc}var async={exports:{}},hasRequiredAsync;function requireAsync(){return hasRequiredAsync||(hasRequiredAsync=1,function(n){(function(){var e={},t,i;t=this,t!=null&&(i=t.async),e.noConflict=function(){return t.async=i,e};function d(r){var s=!1;return function(){if(s)throw new Error("Callback was already called.");s=!0,r.apply(t,arguments)}}var o=function(r,s){if(r.forEach)return r.forEach(s);for(var u=0;u<r.length;u+=1)s(r[u],u,r)},p=function(r,s){if(r.map)return r.map(s);var u=[];return o(r,function(c,l,m){u.push(s(c,l,m))}),u},a=function(r,s,u){return r.reduce?r.reduce(s,u):(o(r,function(c,l,m){u=s(u,c,l,m)}),u)},f=function(r){if(Object.keys)return Object.keys(r);var s=[];for(var u in r)r.hasOwnProperty(u)&&s.push(u);return s};typeof process>"u"||!process.nextTick?typeof setImmediate=="function"?(e.nextTick=function(r){setImmediate(r)},e.setImmediate=e.nextTick):(e.nextTick=function(r){setTimeout(r,0)},e.setImmediate=e.nextTick):(e.nextTick=process.nextTick,typeof setImmediate<"u"?e.setImmediate=function(r){setImmediate(r)}:e.setImmediate=e.nextTick),e.each=function(r,s,u){if(u=u||function(){},!r.length)return u();var c=0;o(r,function(l){s(l,d(function(m){m?(u(m),u=function(){}):(c+=1,c>=r.length&&u(null))}))})},e.forEach=e.each,e.eachSeries=function(r,s,u){if(u=u||function(){},!r.length)return u();var c=0,l=function(){s(r[c],function(m){m?(u(m),u=function(){}):(c+=1,c>=r.length?u(null):l())})};l()},e.forEachSeries=e.eachSeries,e.eachLimit=function(r,s,u,c){var l=y(s);l.apply(null,[r,u,c])},e.forEachLimit=e.eachLimit;var y=function(r){return function(s,u,c){if(c=c||function(){},!s.length||r<=0)return c();var l=0,m=0,P=0;(function S(){if(l>=s.length)return c();for(;P<r&&m<s.length;)m+=1,P+=1,u(s[m-1],function(O){O?(c(O),c=function(){}):(l+=1,P-=1,l>=s.length?c():S())})})()}},x=function(r){return function(){var s=Array.prototype.slice.call(arguments);return r.apply(null,[e.each].concat(s))}},b=function(r,s){return function(){var u=Array.prototype.slice.call(arguments);return s.apply(null,[y(r)].concat(u))}},v=function(r){return function(){var s=Array.prototype.slice.call(arguments);return r.apply(null,[e.eachSeries].concat(s))}},A=function(r,s,u,c){var l=[];s=p(s,function(m,P){return{index:P,value:m}}),r(s,function(m,P){u(m.value,function(S,O){l[m.index]=O,P(S)})},function(m){c(m,l)})};e.map=x(A),e.mapSeries=v(A),e.mapLimit=function(r,s,u,c){return F(s)(r,u,c)};var F=function(r){return b(r,A)};e.reduce=function(r,s,u,c){e.eachSeries(r,function(l,m){u(s,l,function(P,S){s=S,m(P)})},function(l){c(l,s)})},e.inject=e.reduce,e.foldl=e.reduce,e.reduceRight=function(r,s,u,c){var l=p(r,function(m){return m}).reverse();e.reduce(l,s,u,c)},e.foldr=e.reduceRight;var E=function(r,s,u,c){var l=[];s=p(s,function(m,P){return{index:P,value:m}}),r(s,function(m,P){u(m.value,function(S){S&&l.push(m),P()})},function(m){c(p(l.sort(function(P,S){return P.index-S.index}),function(P){return P.value}))})};e.filter=x(E),e.filterSeries=v(E),e.select=e.filter,e.selectSeries=e.filterSeries;var g=function(r,s,u,c){var l=[];s=p(s,function(m,P){return{index:P,value:m}}),r(s,function(m,P){u(m.value,function(S){S||l.push(m),P()})},function(m){c(p(l.sort(function(P,S){return P.index-S.index}),function(P){return P.value}))})};e.reject=x(g),e.rejectSeries=v(g);var C=function(r,s,u,c){r(s,function(l,m){u(l,function(P){P?(c(l),c=function(){}):m()})},function(l){c()})};e.detect=x(C),e.detectSeries=v(C),e.some=function(r,s,u){e.each(r,function(c,l){s(c,function(m){m&&(u(!0),u=function(){}),l()})},function(c){u(!1)})},e.any=e.some,e.every=function(r,s,u){e.each(r,function(c,l){s(c,function(m){m||(u(!1),u=function(){}),l()})},function(c){u(!0)})},e.all=e.every,e.sortBy=function(r,s,u){e.map(r,function(c,l){s(c,function(m,P){m?l(m):l(null,{value:c,criteria:P})})},function(c,l){if(c)return u(c);var m=function(P,S){var O=P.criteria,I=S.criteria;return O<I?-1:O>I?1:0};u(null,p(l.sort(m),function(P){return P.value}))})},e.auto=function(r,s){s=s||function(){};var u=f(r);if(!u.length)return s(null);var c={},l=[],m=function(O){l.unshift(O)},P=function(O){for(var I=0;I<l.length;I+=1)if(l[I]===O){l.splice(I,1);return}},S=function(){o(l.slice(0),function(O){O()})};m(function(){f(c).length===u.length&&(s(null,c),s=function(){})}),o(u,function(O){var I=r[O]instanceof Function?[r[O]]:r[O],k=function(R){var T=Array.prototype.slice.call(arguments,1);if(T.length<=1&&(T=T[0]),R){var D={};o(f(c),function(M){D[M]=c[M]}),D[O]=T,s(R,D),s=function(){}}else c[O]=T,e.setImmediate(S)},j=I.slice(0,Math.abs(I.length-1))||[],W=function(){return a(j,function(R,T){return R&&c.hasOwnProperty(T)},!0)&&!c.hasOwnProperty(O)};if(W())I[I.length-1](k,c);else{var z=function(){W()&&(P(z),I[I.length-1](k,c))};m(z)}})},e.waterfall=function(r,s){if(s=s||function(){},r.constructor!==Array){var u=new Error("First argument to waterfall must be an array of functions");return s(u)}if(!r.length)return s();var c=function(l){return function(m){if(m)s.apply(null,arguments),s=function(){};else{var P=Array.prototype.slice.call(arguments,1),S=l.next();S?P.push(c(S)):P.push(s),e.setImmediate(function(){l.apply(null,P)})}}};c(e.iterator(r))()};var q=function(r,s,u){if(u=u||function(){},s.constructor===Array)r.map(s,function(l,m){l&&l(function(P){var S=Array.prototype.slice.call(arguments,1);S.length<=1&&(S=S[0]),m.call(null,P,S)})},u);else{var c={};r.each(f(s),function(l,m){s[l](function(P){var S=Array.prototype.slice.call(arguments,1);S.length<=1&&(S=S[0]),c[l]=S,m(P)})},function(l){u(l,c)})}};e.parallel=function(r,s){q({map:e.map,each:e.each},r,s)},e.parallelLimit=function(r,s,u){q({map:F(s),each:y(s)},r,u)},e.series=function(r,s){if(s=s||function(){},r.constructor===Array)e.mapSeries(r,function(c,l){c&&c(function(m){var P=Array.prototype.slice.call(arguments,1);P.length<=1&&(P=P[0]),l.call(null,m,P)})},s);else{var u={};e.eachSeries(f(r),function(c,l){r[c](function(m){var P=Array.prototype.slice.call(arguments,1);P.length<=1&&(P=P[0]),u[c]=P,l(m)})},function(c){s(c,u)})}},e.iterator=function(r){var s=function(u){var c=function(){return r.length&&r[u].apply(null,arguments),c.next()};return c.next=function(){return u<r.length-1?s(u+1):null},c};return s(0)},e.apply=function(r){var s=Array.prototype.slice.call(arguments,1);return function(){return r.apply(null,s.concat(Array.prototype.slice.call(arguments)))}};var $=function(r,s,u,c){var l=[];r(s,function(m,P){u(m,function(S,O){l=l.concat(O||[]),P(S)})},function(m){c(m,l)})};e.concat=x($),e.concatSeries=v($),e.whilst=function(r,s,u){r()?s(function(c){if(c)return u(c);e.whilst(r,s,u)}):u()},e.doWhilst=function(r,s,u){r(function(c){if(c)return u(c);s()?e.doWhilst(r,s,u):u()})},e.until=function(r,s,u){r()?u():s(function(c){if(c)return u(c);e.until(r,s,u)})},e.doUntil=function(r,s,u){r(function(c){if(c)return u(c);s()?u():e.doUntil(r,s,u)})},e.queue=function(r,s){s===void 0&&(s=1);function u(m,P,S,O){P.constructor!==Array&&(P=[P]),o(P,function(I){var k={data:I,callback:typeof O=="function"?O:null};S?m.tasks.unshift(k):m.tasks.push(k),m.saturated&&m.tasks.length===s&&m.saturated(),e.setImmediate(m.process)})}var c=0,l={tasks:[],concurrency:s,saturated:null,empty:null,drain:null,push:function(m,P){u(l,m,!1,P)},unshift:function(m,P){u(l,m,!0,P)},process:function(){if(c<l.concurrency&&l.tasks.length){var m=l.tasks.shift();l.empty&&l.tasks.length===0&&l.empty(),c+=1;var P=function(){c-=1,m.callback&&m.callback.apply(m,arguments),l.drain&&l.tasks.length+c===0&&l.drain(),l.process()},S=d(P);r(m.data,S)}},length:function(){return l.tasks.length},running:function(){return c}};return l},e.cargo=function(r,s){var u=!1,c=[],l={tasks:c,payload:s,saturated:null,empty:null,drain:null,push:function(m,P){m.constructor!==Array&&(m=[m]),o(m,function(S){c.push({data:S,callback:typeof P=="function"?P:null}),l.saturated&&c.length===s&&l.saturated()}),e.setImmediate(l.process)},process:function m(){if(!u){if(c.length===0){l.drain&&l.drain();return}var P=typeof s=="number"?c.splice(0,s):c.splice(0),S=p(P,function(O){return O.data});l.empty&&l.empty(),u=!0,r(S,function(){u=!1;var O=arguments;o(P,function(I){I.callback&&I.callback.apply(null,O)}),m()})}},length:function(){return c.length},running:function(){return u}};return l};var w=function(r){return function(s){var u=Array.prototype.slice.call(arguments,1);s.apply(null,u.concat([function(c){var l=Array.prototype.slice.call(arguments,1);typeof console<"u"&&(c?console.error&&console.error(c):console[r]&&o(l,function(m){console[r](m)}))}]))}};e.log=w("log"),e.dir=w("dir"),e.memoize=function(r,s){var u={},c={};s=s||function(m){return m};var l=function(){var m=Array.prototype.slice.call(arguments),P=m.pop(),S=s.apply(null,m);S in u?P.apply(null,u[S]):S in c?c[S].push(P):(c[S]=[P],r.apply(null,m.concat([function(){u[S]=arguments;var O=c[S];delete c[S];for(var I=0,k=O.length;I<k;I++)O[I].apply(null,arguments)}])))};return l.memo=u,l.unmemoized=r,l},e.unmemoize=function(r){return function(){return(r.unmemoized||r).apply(null,arguments)}},e.times=function(r,s,u){for(var c=[],l=0;l<r;l++)c.push(l);return e.map(c,s,u)},e.timesSeries=function(r,s,u){for(var c=[],l=0;l<r;l++)c.push(l);return e.mapSeries(c,s,u)},e.compose=function(){var r=Array.prototype.reverse.call(arguments);return function(){var s=this,u=Array.prototype.slice.call(arguments),c=u.pop();e.reduce(r,u,function(l,m,P){m.apply(s,l.concat([function(){var S=arguments[0],O=Array.prototype.slice.call(arguments,1);P(S,O)}]))},function(l,m){c.apply(s,[l].concat(m))})}};var h=function(r,s){var u=function(){var l=this,m=Array.prototype.slice.call(arguments),P=m.pop();return r(s,function(S,O){S.apply(l,m.concat([O]))},P)};if(arguments.length>2){var c=Array.prototype.slice.call(arguments,2);return u.apply(this,c)}else return u};e.applyEach=x(h),e.applyEachSeries=v(h),e.forever=function(r,s){function u(c){if(c){if(s)return s(c);throw c}r(u)}u()},n.exports?n.exports=e:t.async=e})()}(async)),async.exports}var processor,hasRequiredProcessor;function requireProcessor(){if(hasRequiredProcessor)return processor;hasRequiredProcessor=1;var n=require$$0$1.spawn,e=requireAsync(),t=utilsExports;function i(d){d._inputs[0].isStream||d.ffprobe(0,function(p,a){d._ffprobeData=a})}return processor=function(d){d._spawnFfmpeg=function(o,p,a,f){typeof p=="function"&&(f=a,a=p,p={}),typeof f>"u"&&(f=a,a=function(){});var y="stdoutLines"in p?p.stdoutLines:this.options.stdoutLines;this._getFfmpegPath(function(x,b){if(x)return f(x);if(!b||b.length===0)return f(new Error("Cannot find ffmpeg"));p.niceness&&p.niceness!==0&&!t.isWindows&&(o.unshift("-n",p.niceness,b),b="nice");var v=t.linesRing(y),A=!1,F=t.linesRing(y),E=!1,g=n(b,o,p);g.stderr&&g.stderr.setEncoding("utf8"),g.on("error",function(w){f(w)});var C=null;function q(w){w&&(C=w),$&&(A||!p.captureStdout)&&E&&f(C,v,F)}var $=!1;g.on("exit",function(w,h){$=!0,h?q(new Error("ffmpeg was killed with signal "+h)):w?q(new Error("ffmpeg exited with code "+w)):q()}),p.captureStdout&&(g.stdout.on("data",function(w){v.append(w)}),g.stdout.on("close",function(){v.close(),A=!0,q()})),g.stderr.on("data",function(w){F.append(w)}),g.stderr.on("close",function(){F.close(),E=!0,q()}),a(g,v,F)})},d._getArguments=function(){var o=this._complexFilters.get(),p=this._outputs.some(function(a){return a.isFile});return[].concat(this._inputs.reduce(function(a,f){var y=typeof f.source=="string"?f.source:"pipe:0";return a.concat(f.options.get(),["-i",y])},[]),this._global.get(),p?["-y"]:[],o,this._outputs.reduce(function(a,f){var y=t.makeFilterStrings(f.sizeFilters.get()),x=f.audioFilters.get(),b=f.videoFilters.get().concat(y),v;return f.target?typeof f.target=="string"?v=[f.target]:v=["pipe:1"]:v=[],a.concat(f.audio.get(),x.length?["-filter:a",x.join(",")]:[],f.video.get(),b.length?["-filter:v",b.join(",")]:[],f.options.get(),v)},[]))},d._prepare=function(o,p){var a=this;e.waterfall([function(f){a._checkCapabilities(f)},function(f){if(!p)return f();a.ffprobe(0,function(y,x){y||(a._ffprobeData=x),f()})},function(f){var y=a._outputs.some(function(x){return x.flags.flvmeta&&!x.isFile&&(a.logger.warn("Updating flv metadata is only supported for files"),x.flags.flvmeta=!1),x.flags.flvmeta});y?a._getFlvtoolPath(function(x){f(x)}):f()},function(f){var y;try{y=a._getArguments()}catch(x){return f(x)}f(null,y)},function(f,y){a.availableEncoders(function(x,b){for(var v=0;v<f.length;v++)(f[v]==="-acodec"||f[v]==="-vcodec")&&(v++,f[v]in b&&b[f[v]].experimental&&(f.splice(v+1,0,"-strict","experimental"),v+=2));y(null,f)})}],o),p||(this.listeners("progress").length>0?i(this):this.once("newListener",function(f){f==="progress"&&i(this)}))},d.exec=d.execute=d.run=function(){var o=this,p=this._outputs.some(function(b){return"target"in b});if(!p)throw new Error("No output specified");var a=this._outputs.filter(function(b){return typeof b.target!="string"})[0],f=this._inputs.filter(function(b){return typeof b.source!="string"})[0],y=!1;function x(b,v,A){y||(y=!0,b?o.emit("error",b,v,A):o.emit("end",v,A))}return o._prepare(function(b,v){if(b)return x(b);o._spawnFfmpeg(v,{captureStdout:!a,niceness:o.options.niceness,cwd:o.options.cwd,windowsHide:!0},function(F,E,g){if(o.ffmpegProc=F,o.emit("start","ffmpeg "+v.join(" ")),f&&(f.source.on("error",function($){var w=new Error("Input stream error: "+$.message);w.inputStreamError=$,x(w),F.kill()}),f.source.resume(),f.source.pipe(F.stdin),F.stdin.on("error",function(){})),o.options.timeout&&(o.processTimer=setTimeout(function(){var $="process ran into a timeout ("+o.options.timeout+"s)";x(new Error($),E.get(),g.get()),F.kill()},o.options.timeout*1e3)),a&&(F.stdout.pipe(a.target,a.pipeopts),a.target.on("close",function(){o.logger.debug("Output stream closed, scheduling kill for ffmpeg process"),setTimeout(function(){x(new Error("Output stream closed")),F.kill()},20)}),a.target.on("error",function($){o.logger.debug("Output stream error, killing ffmpeg process");var w=new Error("Output stream error: "+$.message);w.outputStreamError=$,x(w,E.get(),g.get()),F.kill("SIGKILL")})),g){if(o.listeners("stderr").length&&g.callback(function($){o.emit("stderr",$)}),o.listeners("codecData").length){var C=!1,q={};g.callback(function($){C||(C=t.extractCodecData(o,$,q))})}o.listeners("progress").length&&g.callback(function($){t.extractProgress(o,$)})}},function(F,E,g){if(clearTimeout(o.processTimer),delete o.ffmpegProc,F)F.message.match(/ffmpeg exited with code/)&&(F.message+=": "+t.extractError(g.get())),x(F,E.get(),g.get());else{var C=o._outputs.filter(function(q){return q.flags.flvmeta});C.length?o._getFlvtoolPath(function(q,$){if(q)return x(q);e.each(C,function(w,h){n($,["-U",w.target],{windowsHide:!0}).on("error",function(r){h(new Error("Error running "+$+" on "+w.target+": "+r.message))}).on("exit",function(r,s){r!==0||s?h(new Error($+" "+(s?"received signal "+s:"exited with code "+r))+" when running on "+w.target):h()})},function(w){w?x(w):x(null,E.get(),g.get())})}):x(null,E.get(),g.get())}})}),this},d.renice=function(o){if(!t.isWindows&&(o=o||0,(o<-20||o>20)&&this.logger.warn("Invalid niceness value: "+o+", must be between -20 and 20"),o=Math.min(20,Math.max(-20,o)),this.options.niceness=o,this.ffmpegProc)){var p=this.logger,a=this.ffmpegProc.pid,f=n("renice",[o,"-p",a],{windowsHide:!0});f.on("error",function(y){p.warn("could not renice process "+a+": "+y.message)}),f.on("exit",function(y,x){x?p.warn("could not renice process "+a+": renice was killed by signal "+x):y?p.warn("could not renice process "+a+": renice exited with "+y):p.info("successfully reniced process "+a+" to "+o+" niceness")})}return this},d.kill=function(o){return this.ffmpegProc?this.ffmpegProc.kill(o||"SIGKILL"):this.logger.warn("No running ffmpeg process, cannot send signal"),this}},processor}var capabilities,hasRequiredCapabilities;function requireCapabilities(){if(hasRequiredCapabilities)return capabilities;hasRequiredCapabilities=1;var n=require$$0,e=require$$1,t=requireAsync(),i=utilsExports,d=/^\s*([D ])([E ])([VAS])([S ])([D ])([T ]) ([^ ]+) +(.*)$/,o=/^\s*([D\.])([E\.])([VAS])([I\.])([L\.])([S\.]) ([^ ]+) +(.*)$/,p=/\(encoders:([^\)]+)\)/,a=/\(decoders:([^\)]+)\)/,f=/^\s*([VAS\.])([F\.])([S\.])([X\.])([B\.])([D\.]) ([^ ]+) +(.*)$/,y=/^\s*([D ])([E ])\s+([^ ]+)\s+(.*)$/,x=/\r\n|\r|\n/,b=/^(?: [T\.][S\.][C\.] )?([^ ]+) +(AA?|VV?|\|)->(AA?|VV?|\|) +(.*)$/,v={};return capabilities=function(A){A.setFfmpegPath=function(F){return v.ffmpegPath=F,this},A.setFfprobePath=function(F){return v.ffprobePath=F,this},A.setFlvtoolPath=function(F){return v.flvtoolPath=F,this},A._forgetPaths=function(){delete v.ffmpegPath,delete v.ffprobePath,delete v.flvtoolPath},A._getFfmpegPath=function(F){if("ffmpegPath"in v)return F(null,v.ffmpegPath);t.waterfall([function(E){process.env.FFMPEG_PATH?n.exists(process.env.FFMPEG_PATH,function(g){g?E(null,process.env.FFMPEG_PATH):E(null,"")}):E(null,"")},function(E,g){if(E.length)return g(null,E);i.which("ffmpeg",function(C,q){g(C,q)})}],function(E,g){E?F(E):F(null,v.ffmpegPath=g||"")})},A._getFfprobePath=function(F){var E=this;if("ffprobePath"in v)return F(null,v.ffprobePath);t.waterfall([function(g){process.env.FFPROBE_PATH?n.exists(process.env.FFPROBE_PATH,function(C){g(null,C?process.env.FFPROBE_PATH:"")}):g(null,"")},function(g,C){if(g.length)return C(null,g);i.which("ffprobe",function(q,$){C(q,$)})},function(g,C){if(g.length)return C(null,g);E._getFfmpegPath(function(q,$){if(q)C(q);else if($.length){var w=i.isWindows?"ffprobe.exe":"ffprobe",h=e.join(e.dirname($),w);n.exists(h,function(r){C(null,r?h:"")})}else C(null,"")})}],function(g,C){g?F(g):F(null,v.ffprobePath=C||"")})},A._getFlvtoolPath=function(F){if("flvtoolPath"in v)return F(null,v.flvtoolPath);t.waterfall([function(E){process.env.FLVMETA_PATH?n.exists(process.env.FLVMETA_PATH,function(g){E(null,g?process.env.FLVMETA_PATH:"")}):E(null,"")},function(E,g){if(E.length)return g(null,E);process.env.FLVTOOL2_PATH?n.exists(process.env.FLVTOOL2_PATH,function(C){g(null,C?process.env.FLVTOOL2_PATH:"")}):g(null,"")},function(E,g){if(E.length)return g(null,E);i.which("flvmeta",function(C,q){g(C,q)})},function(E,g){if(E.length)return g(null,E);i.which("flvtool2",function(C,q){g(C,q)})}],function(E,g){E?F(E):F(null,v.flvtoolPath=g||"")})},A.availableFilters=A.getAvailableFilters=function(F){if("filters"in v)return F(null,v.filters);this._spawnFfmpeg(["-filters"],{captureStdout:!0,stdoutLines:0},function(E,g){if(E)return F(E);var C=g.get(),q=C.split(`
`),$={},w={A:"audio",V:"video","|":"none"};q.forEach(function(h){var r=h.match(b);r&&($[r[1]]={description:r[4],input:w[r[2].charAt(0)],multipleInputs:r[2].length>1,output:w[r[3].charAt(0)],multipleOutputs:r[3].length>1})}),F(null,v.filters=$)})},A.availableCodecs=A.getAvailableCodecs=function(F){if("codecs"in v)return F(null,v.codecs);this._spawnFfmpeg(["-codecs"],{captureStdout:!0,stdoutLines:0},function(E,g){if(E)return F(E);var C=g.get(),q=C.split(x),$={};q.forEach(function(w){var h=w.match(d);if(h&&h[7]!=="="&&($[h[7]]={type:{V:"video",A:"audio",S:"subtitle"}[h[3]],description:h[8],canDecode:h[1]==="D",canEncode:h[2]==="E",drawHorizBand:h[4]==="S",directRendering:h[5]==="D",weirdFrameTruncation:h[6]==="T"}),h=w.match(o),h&&h[7]!=="="){var r=$[h[7]]={type:{V:"video",A:"audio",S:"subtitle"}[h[3]],description:h[8],canDecode:h[1]==="D",canEncode:h[2]==="E",intraFrameOnly:h[4]==="I",isLossy:h[5]==="L",isLossless:h[6]==="S"},s=r.description.match(p);s=s?s[1].trim().split(" "):[];var u=r.description.match(a);if(u=u?u[1].trim().split(" "):[],s.length||u.length){var c={};i.copy(r,c),delete c.canEncode,delete c.canDecode,s.forEach(function(l){$[l]={},i.copy(c,$[l]),$[l].canEncode=!0}),u.forEach(function(l){l in $||($[l]={},i.copy(c,$[l])),$[l].canDecode=!0})}}}),F(null,v.codecs=$)})},A.availableEncoders=A.getAvailableEncoders=function(F){if("encoders"in v)return F(null,v.encoders);this._spawnFfmpeg(["-encoders"],{captureStdout:!0,stdoutLines:0},function(E,g){if(E)return F(E);var C=g.get(),q=C.split(x),$={};q.forEach(function(w){var h=w.match(f);h&&h[7]!=="="&&($[h[7]]={type:{V:"video",A:"audio",S:"subtitle"}[h[1]],description:h[8],frameMT:h[2]==="F",sliceMT:h[3]==="S",experimental:h[4]==="X",drawHorizBand:h[5]==="B",directRendering:h[6]==="D"})}),F(null,v.encoders=$)})},A.availableFormats=A.getAvailableFormats=function(F){if("formats"in v)return F(null,v.formats);this._spawnFfmpeg(["-formats"],{captureStdout:!0,stdoutLines:0},function(E,g){if(E)return F(E);var C=g.get(),q=C.split(x),$={};q.forEach(function(w){var h=w.match(y);h&&h[3].split(",").forEach(function(r){r in $||($[r]={description:h[4],canDemux:!1,canMux:!1}),h[1]==="D"&&($[r].canDemux=!0),h[2]==="E"&&($[r].canMux=!0)})}),F(null,v.formats=$)})},A._checkCapabilities=function(F){var E=this;t.waterfall([function(g){E.availableFormats(g)},function(g,C){var q;if(q=E._outputs.reduce(function($,w){var h=w.options.find("-f",1);return h&&(!(h[0]in g)||!g[h[0]].canMux)&&$.push(h),$},[]),q.length===1)return C(new Error("Output format "+q[0]+" is not available"));if(q.length>1)return C(new Error("Output formats "+q.join(", ")+" are not available"));if(q=E._inputs.reduce(function($,w){var h=w.options.find("-f",1);return h&&(!(h[0]in g)||!g[h[0]].canDemux)&&$.push(h[0]),$},[]),q.length===1)return C(new Error("Input format "+q[0]+" is not available"));if(q.length>1)return C(new Error("Input formats "+q.join(", ")+" are not available"));C()},function(g){E.availableEncoders(g)},function(g,C){var q;if(q=E._outputs.reduce(function($,w){var h=w.audio.find("-acodec",1);return h&&h[0]!=="copy"&&(!(h[0]in g)||g[h[0]].type!=="audio")&&$.push(h[0]),$},[]),q.length===1)return C(new Error("Audio codec "+q[0]+" is not available"));if(q.length>1)return C(new Error("Audio codecs "+q.join(", ")+" are not available"));if(q=E._outputs.reduce(function($,w){var h=w.video.find("-vcodec",1);return h&&h[0]!=="copy"&&(!(h[0]in g)||g[h[0]].type!=="video")&&$.push(h[0]),$},[]),q.length===1)return C(new Error("Video codec "+q[0]+" is not available"));if(q.length>1)return C(new Error("Video codecs "+q.join(", ")+" are not available"));C()}],F)}},capabilities}var ffprobe,hasRequiredFfprobe;function requireFfprobe(){if(hasRequiredFfprobe)return ffprobe;hasRequiredFfprobe=1;var n=require$$0$1.spawn;function e(d){return d.match(/^TAG:/)}function t(d){return d.match(/^DISPOSITION:/)}function i(d){var o=d.split(/\r\n|\r|\n/);o=o.filter(function(b){return b.length>0});var p={streams:[],format:{},chapters:[]};function a(b){for(var v={},A=o.shift();typeof A<"u";){if(A.toLowerCase()=="[/"+b+"]")return v;if(A.match(/^\[/)){A=o.shift();continue}var F=A.match(/^([^=]+)=(.*)$/);F&&(!F[1].match(/^TAG:/)&&F[2].match(/^[0-9]+(\.[0-9]+)?$/)?v[F[1]]=Number(F[2]):v[F[1]]=F[2]),A=o.shift()}return v}for(var f=o.shift();typeof f<"u";){if(f.match(/^\[stream/i)){var y=a("stream");p.streams.push(y)}else if(f.match(/^\[chapter/i)){var x=a("chapter");p.chapters.push(x)}else f.toLowerCase()==="[format]"&&(p.format=a("format"));f=o.shift()}return p}return ffprobe=function(d){d.ffprobe=function(){var o,p=null,a=[],f,f=arguments[arguments.length-1],y=!1;function x(b,v){y||(y=!0,f(b,v))}switch(arguments.length){case 3:p=arguments[0],a=arguments[1];break;case 2:typeof arguments[0]=="number"?p=arguments[0]:Array.isArray(arguments[0])&&(a=arguments[0]);break}if(p===null){if(!this._currentInput)return x(new Error("No input specified"));o=this._currentInput}else if(o=this._inputs[p],!o)return x(new Error("Invalid input index"));this._getFfprobePath(function(b,v){if(b)return x(b);if(!v)return x(new Error("Cannot find ffprobe"));var A="",F=!1,E="",g=!1,C=o.isStream?"pipe:0":o.source,q=n(v,["-show_streams","-show_format"].concat(a,C),{windowsHide:!0});o.isStream&&(q.stdin.on("error",function(r){["ECONNRESET","EPIPE","EOF"].indexOf(r.code)>=0||x(r)}),q.stdin.on("close",function(){o.source.pause(),o.source.unpipe(q.stdin)}),o.source.pipe(q.stdin)),q.on("error",f);var $=null;function w(r){if(r&&($=r),h&&F&&g){if($)return E&&($.message+=`
`+E),x($);var s=i(A);[s.format].concat(s.streams).forEach(function(u){if(u){var c=Object.keys(u).filter(e);c.length&&(u.tags=u.tags||{},c.forEach(function(m){u.tags[m.substr(4)]=u[m],delete u[m]}));var l=Object.keys(u).filter(t);l.length&&(u.disposition=u.disposition||{},l.forEach(function(m){u.disposition[m.substr(12)]=u[m],delete u[m]}))}}),x(null,s)}}var h=!1;q.on("exit",function(r,s){h=!0,r?w(new Error("ffprobe exited with code "+r)):s?w(new Error("ffprobe was killed with signal "+s)):w()}),q.stdout.on("data",function(r){A+=r}),q.stdout.on("close",function(){F=!0,w()}),q.stderr.on("data",function(r){E+=r}),q.stderr.on("close",function(){g=!0,w()})})}},ffprobe}var recipes,hasRequiredRecipes;function requireRecipes(){if(hasRequiredRecipes)return recipes;hasRequiredRecipes=1;var n=require$$0,e=require$$1,t=require$$2.PassThrough,i=requireAsync(),d=utilsExports;return recipes=function(p){p.saveToFile=p.save=function(a){return this.output(a).run(),this},p.writeToStream=p.pipe=p.stream=function(a,f){if(a&&!("writable"in a)&&(f=a,a=void 0),!a){if(process.version.match(/v0\.8\./))throw new Error("PassThrough stream is not supported on node v0.8");a=new t}return this.output(a,f).run(),a},p.takeScreenshots=p.thumbnail=p.thumbnails=p.screenshot=p.screenshots=function(a,f){var y=this,x=this._currentInput.source;if(a=a||{count:1},typeof a=="number"&&(a={count:a}),"folder"in a||(a.folder=f||"."),"timestamps"in a&&(a.timemarks=a.timestamps),!("timemarks"in a)){if(!a.count)throw new Error("Cannot take screenshots: neither a count nor a timemark list are specified");var b=100/(1+a.count);a.timemarks=[];for(var v=0;v<a.count;v++)a.timemarks.push(b*(v+1)+"%")}if("size"in a){var A=a.size.match(/^(\d+)x(\d+)$/),F=a.size.match(/^(\d+)x\?$/),E=a.size.match(/^\?x(\d+)$/),g=a.size.match(/^(\d+)%$/);if(!A&&!F&&!E&&!g)throw new Error("Invalid size parameter: "+a.size)}var C;function q($){C?$(null,C):y.ffprobe(function(w,h){C=h,$(w,h)})}return i.waterfall([function(w){if(a.timemarks.some(function(h){return(""+h).match(/^[\d.]+%$/)})){if(typeof x!="string")return w(new Error("Cannot compute screenshot timemarks with an input stream, please specify fixed timemarks"));q(function(h,r){if(h)w(h);else{var s=r.streams.reduce(function(c,l){return l.codec_type==="video"&&l.width*l.height>c.width*c.height?l:c},{width:0,height:0});if(s.width===0)return w(new Error("No video stream in input, cannot take screenshots"));var u=Number(s.duration);if(isNaN(u)&&(u=Number(r.format.duration)),isNaN(u))return w(new Error("Could not get input duration, please specify fixed timemarks"));a.timemarks=a.timemarks.map(function(c){return(""+c).match(/^([\d.]+)%$/)?u*parseFloat(c)/100:c}),w()}})}else w()},function(w){a.timemarks=a.timemarks.map(function(h){return d.timemarkToSeconds(h)}).sort(function(h,r){return h-r}),w()},function(w){var h=a.filename||"tn.png";if(h.indexOf(".")===-1&&(h+=".png"),a.timemarks.length>1&&!h.match(/%(s|0*i)/)){var r=e.extname(h);h=e.join(e.dirname(h),e.basename(h,r)+"_%i"+r)}w(null,h)},function(w,h){if(w.match(/%[bf]/)){if(typeof x!="string")return h(new Error("Cannot replace %f or %b when using an input stream"));w=w.replace(/%f/g,e.basename(x)).replace(/%b/g,e.basename(x,e.extname(x)))}h(null,w)},function(w,h){if(w.match(/%[whr]/)){if(A)return h(null,w,A[1],A[2]);q(function(r,s){if(r)return h(new Error("Could not determine video resolution to replace %w, %h or %r"));var u=s.streams.reduce(function(m,P){return P.codec_type==="video"&&P.width*P.height>m.width*m.height?P:m},{width:0,height:0});if(u.width===0)return h(new Error("No video stream in input, cannot replace %w, %h or %r"));var c=u.width,l=u.height;F?(l=l*Number(F[1])/c,c=Number(F[1])):E?(c=c*Number(E[1])/l,l=Number(E[1])):g&&(c=c*Number(g[1])/100,l=l*Number(g[1])/100),h(null,w,Math.round(c/2)*2,Math.round(l/2)*2)})}else h(null,w,-1,-1)},function(w,h,r,s){w=w.replace(/%r/g,"%wx%h").replace(/%w/g,h).replace(/%h/g,r),s(null,w)},function(w,h){var r=a.timemarks.map(function(s,u){return w.replace(/%s/g,d.timemarkToSeconds(s)).replace(/%(0*)i/g,function(c,l){var m=""+(u+1);return l.substr(0,Math.max(0,l.length+1-m.length))+m})});y.emit("filenames",r),h(null,r)},function(w,h){n.exists(a.folder,function(r){r?h(null,w):n.mkdir(a.folder,function(s){s?h(s):h(null,w)})})}],function(w,h){if(w)return y.emit("error",w);var r=a.timemarks.length,s,u=[s={filter:"split",options:r,outputs:[]}];if("size"in a){y.size(a.size);var c=y._currentOutput.sizeFilters.get().map(function(S,O){return O>0&&(S.inputs="size"+(O-1)),S.outputs="size"+O,S});s.inputs="size"+(c.length-1),u=c.concat(u),y._currentOutput.sizeFilters.clear()}for(var l=0,m=0;m<r;m++){var P="screen"+m;s.outputs.push(P),m===0&&(l=a.timemarks[m],y.seekInput(l)),y.output(e.join(a.folder,h[m])).frames(1).map(P),m>0&&y.seek(a.timemarks[m]-l)}y.complexFilter(u),y.run()}),this},p.mergeToFile=p.concatenate=p.concat=function(a,f){var y=this._inputs.filter(function(b){return!b.isStream})[0],x=this;return this.ffprobe(this._inputs.indexOf(y),function(b,v){if(b)return x.emit("error",b);var A=v.streams.some(function(E){return E.codec_type==="audio"}),F=v.streams.some(function(E){return E.codec_type==="video"});x.output(a,f).complexFilter({filter:"concat",options:{n:x._inputs.length,v:F?1:0,a:A?1:0}}).run()}),this}},recipes}var path=require$$1,util=require$$1$2,EventEmitter=require$$2$1.EventEmitter,utils=utilsExports;function FfmpegCommand(n,e){if(!(this instanceof FfmpegCommand))return new FfmpegCommand(n,e);EventEmitter.call(this),typeof n=="object"&&!("readable"in n)?e=n:(e=e||{},e.source=n),this._inputs=[],e.source&&this.input(e.source),this._outputs=[],this.output();var t=this;["_global","_complexFilters"].forEach(function(i){t[i]=utils.args()}),e.stdoutLines="stdoutLines"in e?e.stdoutLines:100,e.presets=e.presets||e.preset||path.join(__dirname,"presets"),e.niceness=e.niceness||e.priority||0,this.options=e,this.logger=e.logger||{debug:function(){},info:function(){},warn:function(){},error:function(){}}}util.inherits(FfmpegCommand,EventEmitter);var fluentFfmpeg$1=FfmpegCommand;FfmpegCommand.prototype.clone=function(){var n=new FfmpegCommand,e=this;return n.options=this.options,n.logger=this.logger,n._inputs=this._inputs.map(function(t){return{source:t.source,options:t.options.clone()}}),"target"in this._outputs[0]?(n._outputs=[],n.output()):(n._outputs=[n._currentOutput={flags:{}}],["audio","audioFilters","video","videoFilters","sizeFilters","options"].forEach(function(t){n._currentOutput[t]=e._currentOutput[t].clone()}),this._currentOutput.sizeData&&(n._currentOutput.sizeData={},utils.copy(this._currentOutput.sizeData,n._currentOutput.sizeData)),utils.copy(this._currentOutput.flags,n._currentOutput.flags)),["_global","_complexFilters"].forEach(function(t){n[t]=e[t].clone()}),n};requireInputs()(FfmpegCommand.prototype);requireAudio()(FfmpegCommand.prototype);requireVideo()(FfmpegCommand.prototype);requireVideosize()(FfmpegCommand.prototype);requireOutput()(FfmpegCommand.prototype);requireCustom()(FfmpegCommand.prototype);requireMisc()(FfmpegCommand.prototype);requireProcessor()(FfmpegCommand.prototype);requireCapabilities()(FfmpegCommand.prototype);FfmpegCommand.setFfmpegPath=function(n){new FfmpegCommand().setFfmpegPath(n)};FfmpegCommand.setFfprobePath=function(n){new FfmpegCommand().setFfprobePath(n)};FfmpegCommand.setFlvtoolPath=function(n){new FfmpegCommand().setFlvtoolPath(n)};FfmpegCommand.availableFilters=FfmpegCommand.getAvailableFilters=function(n){new FfmpegCommand().availableFilters(n)};FfmpegCommand.availableCodecs=FfmpegCommand.getAvailableCodecs=function(n){new FfmpegCommand().availableCodecs(n)};FfmpegCommand.availableFormats=FfmpegCommand.getAvailableFormats=function(n){new FfmpegCommand().availableFormats(n)};FfmpegCommand.availableEncoders=FfmpegCommand.getAvailableEncoders=function(n){new FfmpegCommand().availableEncoders(n)};requireFfprobe()(FfmpegCommand.prototype);FfmpegCommand.ffprobe=function(n){var e=new FfmpegCommand(n);e.ffprobe.apply(e,Array.prototype.slice.call(arguments,1))};requireRecipes()(FfmpegCommand.prototype);var fluentFfmpeg=fluentFfmpeg$1;const ffmpeg=getDefaultExportFromCjs(fluentFfmpeg),appPath=process.argv[1]||process.cwd(),appDir=require$$1.dirname(appPath),dragIconPaths=[require$$1.join(appDir,"..","..","..","64x64.png"),require$$1.join(process.resourcesPath,"64x64.png"),require$$1.join(process.resourcesPath,"app.asar","64x64.png"),require$$1.join(electron.app.getAppPath(),"64x64.png")],dragIconPath=dragIconPaths.find(n=>require$$0.existsSync(n))||dragIconPaths[0];electron.app.disableHardwareAcceleration();process.on("uncaughtException",n=>{console.error("Uncaught Exception:",n)});process.on("unhandledRejection",(n,e)=>{console.error("Unhandled Rejection at:",e,"reason:",n)});electron.app.disableHardwareAcceleration();let mainWindow=null,tray=null,isQuitting=!1,backendProcess=null;const getBackendPaths=()=>{const n=!isDev;return{backendPath:n?require$$1.join(process.resourcesPath,"bin","ClipVault.exe"):require$$1.join(appDir,"..","..","..","bin","ClipVault.exe"),backendLogPath:n?require$$1.join(process.resourcesPath,"bin","clipvault.log"):require$$1.join(appDir,"..","..","..","bin","clipvault.log")}};function startBackend(){const{backendPath:n}=getBackendPaths();if(!require$$0.existsSync(n))return console.warn("Backend executable not found:",n),!1;try{console.log("Spawning backend from:",n);const e=require$$0$1.spawn(n,[],{detached:!0,stdio:["ignore","ignore","ignore"]});return e.on("error",t=>{console.error("Backend spawn error:",t)}),e.on("exit",(t,i)=>{console.log(`Backend exited with code ${t} and signal ${i}`),backendProcess===e&&(backendProcess=null)}),console.log("Backend spawned with PID:",e.pid),backendProcess=e,e.unref(),!0}catch(e){return console.error("Failed to start backend:",e),!1}}function killBackend(){if(!backendProcess)try{return require$$0$1.execSync('taskkill /F /IM ClipVault.exe /FI "WINDOWTITLE eq ClipVault"',{stdio:"ignore"}),console.log("Killed existing backend processes"),!0}catch{return!1}try{return console.log("Killing backend process with PID:",backendProcess.pid),backendProcess.kill(),backendProcess=null,!0}catch(n){return console.error("Failed to kill backend:",n),!1}}async function restartBackend(){return console.log("Restarting backend..."),killBackend(),await new Promise(n=>setTimeout(n,1e3)),startBackend()}const isDev=process.env.NODE_ENV==="development",clipsPath="D:\\Clips\\ClipVault",thumbnailsPath=require$$1.join(electron.app.getPath("userData"),"thumbnails"),ffmpegPath=require$$1.join(process.resourcesPath,"ffmpeg","ffmpeg.exe"),ffprobePath=require$$1.join(process.resourcesPath,"ffmpeg","ffprobe.exe");require$$0.existsSync(ffmpegPath)&&(process.env.PATH=`${require$$1.dirname(ffmpegPath)}:${process.env.PATH}`,console.log("Using bundled FFmpeg:",ffmpegPath));require$$0.existsSync(ffprobePath)&&console.log("Using bundled FFprobe:",ffprobePath);console.log("Config:",{clipsPath,thumbnailsPath,userData:electron.app.getPath("userData")});const gotTheLock=electron.app.requestSingleInstanceLock();gotTheLock?electron.app.on("second-instance",()=>{console.log("Second instance detected, focusing existing window and checking backend"),mainWindow&&(mainWindow.isMinimized()&&mainWindow.restore(),mainWindow.show(),mainWindow.focus());const e=!isDev?require$$1.join(process.resourcesPath,"bin","ClipVault.exe"):require$$1.join(appDir,"..","..","..","bin","ClipVault.exe");if(require$$0.existsSync(e))try{console.log("Second instance: Spawning backend from:",e);const t=require$$0$1.spawn(e,[],{detached:!0,stdio:["ignore","ignore","ignore"]});t.unref(),console.log("Second instance: Backend spawn attempted with PID:",t.pid)}catch(t){console.error("Second instance: Failed to start backend:",t)}}):(console.log("Another instance is already running. Quitting."),electron.app.quit());electron.protocol.registerSchemesAsPrivileged([{scheme:"clipvault",privileges:{secure:!0,supportFetchAPI:!0,bypassCSP:!0,corsEnabled:!0}}]);function createTray(){console.log("Creating tray icon...");let n;require$$0.existsSync(dragIconPath)&&(n=electron.nativeImage.createFromPath(dragIconPath),n.isEmpty()&&(n=void 0)),n||(n=electron.nativeImage.createFromPath(require$$1.join(appDir,"..","renderer","favicon.ico")),n!=null&&n.isEmpty()&&(n=void 0)),tray=new electron.Tray(n||electron.nativeImage.createEmpty()),tray.setToolTip("ClipVault Editor"),tray.setContextMenu(electron.Menu.buildFromTemplate([{label:"Open ClipVault",click:()=>{mainWindow&&(mainWindow.show(),mainWindow.focus())}},{label:"Open Clips Folder",click:async()=>{const e=clipsPath;require$$0.existsSync(e)||await promises.mkdir(e,{recursive:!0}),await electron.shell.openPath(e)}},{type:"separator"},{label:"Exit",click:()=>{electron.app.quit()}}])),tray.on("click",()=>{mainWindow&&(mainWindow.isVisible()?mainWindow.hide():(mainWindow.show(),mainWindow.focus()))}),tray.on("double-click",()=>{mainWindow&&(mainWindow.show(),mainWindow.focus())}),console.log("Tray icon created")}async function createWindow(){console.log("Creating main window..."),mainWindow=new electron.BrowserWindow({width:1400,height:900,minWidth:1e3,minHeight:600,title:"ClipVault Editor",backgroundColor:"#0f0f0f",show:!0,webPreferences:{preload:isDev?require$$1.join(appDir,"..","preload","index.js"):require$$1.join(process.resourcesPath,"app.asar","dist","preload","index.js"),contextIsolation:!0,nodeIntegration:!1,sandbox:!1,webSecurity:!1},titleBarStyle:"hiddenInset",...process.platform==="win32"?{titleBarOverlay:{color:"#0f0f0f",symbolColor:"#ffffff"}}:{}}),console.log("Main window created, loading content...");try{isDev?(await mainWindow.loadURL("http://localhost:5173"),console.log("Loaded dev URL, opening devtools..."),mainWindow.webContents.openDevTools()):(await mainWindow.loadFile(isDev?require$$1.join(appDir,"..","renderer","index.html"):require$$1.join(process.resourcesPath,"app.asar","dist","renderer","index.html")),console.log("Loaded production HTML file"))}catch(n){console.error("Error loading window content:",n)}electron.Menu.setApplicationMenu(null),mainWindow.webContents.on("crashed",(n,e)=>{console.error("Window crashed!",{killed:e}),e||mainWindow==null||mainWindow.reload()}),electron.app.on("gpu-process-crashed",(n,e)=>{console.error("GPU process crashed!",{killed:e})}),mainWindow.once("ready-to-show",()=>{console.log("Window ready to show, showing now..."),mainWindow==null||mainWindow.show(),mainWindow==null||mainWindow.focus()}),setTimeout(()=>{mainWindow&&!mainWindow.isVisible()&&(console.log("Fallback: forcing window to show after timeout"),mainWindow.show(),mainWindow.focus())},2e3),mainWindow.on("close",n=>{isQuitting||(n.preventDefault(),console.log("Minimizing to tray instead of closing"),mainWindow==null||mainWindow.hide())}),mainWindow.on("page-title-updated",n=>{n.preventDefault()}),mainWindow.on("closed",()=>{mainWindow=null}),mainWindow.webContents.on("before-input-event",(n,e)=>{e.key==="F12"&&(mainWindow==null||mainWindow.webContents.toggleDevTools(),n.preventDefault())})}const getSettingsPath=()=>{const n=process.env.APPDATA||electron.app.getPath("appData");return require$$1.join(n,"ClipVault","settings.json")},defaultSettings={output_path:"D:\\Clips\\ClipVault",buffer_seconds:120,video:{width:1920,height:1080,fps:60,encoder:"auto",quality:20},audio:{sample_rate:48e3,bitrate:160,system_audio_enabled:!0,microphone_enabled:!0},hotkey:{save_clip:"F9"}};electron.ipcMain.handle("settings:get",async()=>{try{const n=getSettingsPath();if(console.log("Settings path:",n),!require$$0.existsSync(n))return console.log("Settings file not found, returning defaults"),defaultSettings;console.log("Reading settings from:",n);const e=await promises.readFile(n,"utf-8");try{return JSON.parse(e)}catch(t){return console.error("JSON parse error, returning defaults:",t),defaultSettings}}catch(n){return console.error("Failed to read settings:",n),defaultSettings}});electron.ipcMain.handle("settings:save",async(n,e)=>{try{const t=getSettingsPath(),i=require$$1.join(electron.app.getPath("appData"),"ClipVault");return require$$0.existsSync(i)||await promises.mkdir(i,{recursive:!0}),await promises.writeFile(t,JSON.stringify(e,null,2),"utf-8"),console.log("Settings saved to:",t),console.log("Settings saved, restarting backend..."),{success:!0,restarted:await restartBackend()}}catch(t){throw console.error("Failed to save settings:",t),t}});electron.ipcMain.handle("backend:restart",async()=>{try{return{success:!0,restarted:await restartBackend()}}catch(n){throw console.error("Failed to restart backend:",n),n}});electron.ipcMain.handle("system:getMonitors",async()=>{try{return electron.screen.getAllDisplays().map((e,t)=>({id:t,name:`Monitor ${t+1}`,width:e.bounds.width,height:e.bounds.height,x:e.bounds.x,y:e.bounds.y,primary:e.bounds.x===0&&e.bounds.y===0}))}catch(n){throw console.error("Failed to get monitors:",n),n}});electron.ipcMain.handle("clips:getList",async()=>{try{if(!require$$0.existsSync(clipsPath))return await promises.mkdir(clipsPath,{recursive:!0}),[];const n=await promises.readdir(clipsPath);return(await Promise.all(n.filter(t=>t.endsWith(".mp4")).map(async t=>{const i=require$$1.join(clipsPath,t),d=await promises.stat(i),o=i.replace(".mp4",".clipvault.json");let p=null;try{if(require$$0.existsSync(o)){const a=await promises.readFile(o,"utf-8");p=JSON.parse(a)}}catch(a){console.error("Failed to read metadata:",a)}return{id:t.replace(".mp4",""),filename:t,path:i,size:d.size,createdAt:d.birthtime.toISOString(),modifiedAt:d.mtime.toISOString(),metadata:p}}))).sort((t,i)=>new Date(i.createdAt).getTime()-new Date(t.createdAt).getTime())}catch(n){throw console.error("Failed to get clips list:",n),n}});electron.ipcMain.handle("clips:saveMetadata",async(n,e,t)=>{try{const i=require$$1.join(clipsPath,`${e}.clipvault.json`);return await promises.writeFile(i,JSON.stringify(t,null,2),"utf-8"),!0}catch(i){throw console.error("Failed to save metadata:",i),i}});electron.ipcMain.handle("clips:getMetadata",async(n,e)=>{try{const t=require$$1.join(clipsPath,`${e}.clipvault.json`);if(!require$$0.existsSync(t))return null;const i=await promises.readFile(t,"utf-8");return JSON.parse(i)}catch(t){return console.error("Failed to get metadata:",t),null}});electron.ipcMain.handle("system:openFolder",async()=>{await electron.shell.openPath(clipsPath)});electron.ipcMain.handle("dialog:save",async(n,e)=>mainWindow?await electron.dialog.showSaveDialog(mainWindow,e):null);electron.ipcMain.handle("clips:generateThumbnail",async(n,e,t)=>{try{require$$0.existsSync(thumbnailsPath)||await promises.mkdir(thumbnailsPath,{recursive:!0});const i=`${e}.jpg`,d=require$$1.join(thumbnailsPath,i);return require$$0.existsSync(d)?`clipvault://thumb/${encodeURIComponent(i)}`:new Promise((o,p)=>{ffmpeg(t).screenshots({timestamps:["10%"],filename:i,folder:thumbnailsPath,size:"480x270"}).on("end",()=>{o(`clipvault://thumb/${encodeURIComponent(i)}`)}).on("error",a=>{console.error("FFmpeg error:",a),p(a)})})}catch(i){throw console.error("Failed to generate thumbnail:",i),i}});electron.ipcMain.handle("video:getFileUrl",async(n,e)=>{try{const t=require$$1.join(clipsPath,e);if(!require$$0.existsSync(t))return console.error("Video file not found:",t),{success:!1,error:"File not found"};const i=`file:///${t.replace(/\\/g,"/")}`;return console.log("Returning video file URL:",i),{success:!0,url:i,path:t}}catch(t){return console.error("Error getting video file URL:",t),{success:!1,error:String(t)}}});electron.ipcMain.handle("clips:getVideoMetadata",async(_,videoPath)=>{try{return new Promise((resolve,reject)=>{ffmpeg.ffprobe(videoPath,(err,metadata)=>{if(err){reject(err);return}const videoStream=metadata.streams.find(n=>n.codec_type==="video"),audioStreams=metadata.streams.filter(n=>n.codec_type==="audio");resolve({duration:metadata.format.duration||0,width:(videoStream==null?void 0:videoStream.width)||0,height:(videoStream==null?void 0:videoStream.height)||0,fps:videoStream?eval(videoStream.r_frame_rate||"0"):0,bitrate:metadata.format.bit_rate||0,size:metadata.format.size||0,format:metadata.format.format_name||"",videoCodec:(videoStream==null?void 0:videoStream.codec_name)||"",audioTracks:audioStreams.length})})})}catch(n){throw console.error("Failed to get video metadata:",n),n}});let exportPreviewWindow=null;function createExportPreviewWindow(n){exportPreviewWindow&&!exportPreviewWindow.isDestroyed()&&exportPreviewWindow.close(),exportPreviewWindow=new electron.BrowserWindow({width:600,height:500,alwaysOnTop:!0,modal:!1,resizable:!1,title:"Export Complete",backgroundColor:"#1a1a1a",webPreferences:{contextIsolation:!1,nodeIntegration:!0,webSecurity:!1}}),exportPreviewWindow.setMenu(null),exportPreviewWindow.webContents.on("crashed",()=>{console.error("Preview window crashed"),exportPreviewWindow==null||exportPreviewWindow.close(),exportPreviewWindow=null});const e=n.split("\\").pop()||"",d=`<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <style>
    * { box-sizing: border-box; }
    body { margin: 0; padding: 20px; background: #1a1a1a; color: white; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; overflow: hidden; }
    video { width: 100%; border-radius: 8px; max-height: 320px; object-fit: contain; background: #000; }
    .drag-hint { text-align: center; padding: 15px; background: #2a2a2a; border-radius: 8px; margin-top: 10px; cursor: grab; user-select: none; }
    .drag-hint:active { cursor: grabbing; }
    .drag-hint h3 { margin: 0 0 8px 0; font-size: 16px; color: #4ade80; }
    .drag-hint p { margin: 0; font-size: 13px; color: #aaa; }
    .timer { position: absolute; top: 10px; right: 10px; font-size: 12px; color: #666; }
    .file-icon { font-size: 24px; margin-bottom: 8px; }
    .actions { display: flex; gap: 10px; margin-top: 10px; }
    .btn { flex: 1; padding: 10px; background: #3a3a3a; border: none; border-radius: 6px; color: white; cursor: pointer; font-size: 13px; }
    .btn:hover { background: #4a4a4a; }
    .btn-primary { background: #4ade80; color: #0f0f0f; }
    .btn-primary:hover { background: #22c55e; }
  </style>
</head>
<body>
  <div class="timer" id="timer">Closing in 30s</div>
  <video src="${`clipvault://${n.includes("exported-clips")?"exported":"clip"}/${encodeURIComponent(e)}`}" controls autoplay></video>
  <div class="drag-hint" id="dragHint" draggable="true">
    <div class="file-icon"></div>
    <h3>Export Complete!</h3>
    <p>Drag from here to share the file anywhere</p>
  </div>
  <div class="actions">
    <button class="btn" onclick="copyPath()">Copy Path</button>
    <button class="btn btn-primary" onclick="openFolder()">Open Folder</button>
  </div>
  <script>
    const { ipcRenderer } = require('electron');
    const filePath = '${n.replace(/\\/g,"\\\\")}';
    let timeLeft = 30;
    const timerEl = document.getElementById('timer');
    const interval = setInterval(() => {
      timeLeft--;
      timerEl.textContent = 'Closing in ' + timeLeft + 's';
      if (timeLeft <= 0) {
        clearInterval(interval);
        window.close();
      }
    }, 1000);
    
    // Handle drag start - send IPC to main process for native drag
    const dragHint = document.getElementById('dragHint');
    dragHint.addEventListener('dragstart', (e) => {
      e.preventDefault();
      // Send IPC to main process to initiate native drag
      ipcRenderer.send('export:startDrag', filePath);
    });
    
    function copyPath() {
      navigator.clipboard.writeText(filePath);
      const btn = event.target;
      const originalText = btn.textContent;
      btn.textContent = 'Copied!';
      setTimeout(() => btn.textContent = originalText, 1500);
    }
    
    function openFolder() {
      ipcRenderer.send('export:openFolder', filePath);
    }
  <\/script>
</body>
</html>`;exportPreviewWindow.loadURL("data:text/html;charset=utf-8,"+encodeURIComponent(d));const o=setTimeout(()=>{exportPreviewWindow&&!exportPreviewWindow.isDestroyed()&&exportPreviewWindow.close()},3e4);exportPreviewWindow.on("closed",()=>{clearTimeout(o),exportPreviewWindow=null}),exportPreviewWindow.webContents.on("ipc-message",(p,a,f)=>{if(a==="export:startDrag"){console.log("Starting native drag for:",f);try{let y;require$$0.existsSync(dragIconPath)?(y=electron.nativeImage.createFromPath(dragIconPath),console.log("Drag icon loaded from:",dragIconPath)):console.warn("Drag icon not found at:",dragIconPath),exportPreviewWindow==null||exportPreviewWindow.webContents.startDrag({file:f,icon:y||electron.nativeImage.createEmpty()})}catch(y){console.error("Error starting drag:",y)}}else if(a==="export:openFolder"){const y=require$$1.dirname(f);electron.shell.openPath(y)}})}electron.ipcMain.handle("export:showPreview",async(n,e)=>(createExportPreviewWindow(e),{success:!0}));electron.ipcMain.handle("audio:extractTracks",async(n,e,t)=>{try{const i=require$$1.join(thumbnailsPath,"audio");require$$0.existsSync(i)||await promises.mkdir(i,{recursive:!0});const d=require$$1.join(i,`${e}_track1.m4a`),o=require$$1.join(i,`${e}_track2.m4a`),p={},a=require$$0.existsSync(d),f=require$$0.existsSync(o);if(a&&(p.track1=`clipvault://audio/${encodeURIComponent(`${e}_track1.m4a`)}`),f&&(p.track2=`clipvault://audio/${encodeURIComponent(`${e}_track2.m4a`)}`),a&&f)return p;const x=(await new Promise((b,v)=>{ffmpeg.ffprobe(t,(A,F)=>{A?v(A):b(F)})})).streams.filter(b=>b.codec_type==="audio");return!a&&x.length>=1&&(await new Promise((b,v)=>{ffmpeg(t).outputOptions(["-map 0:a:0","-c:a aac","-b:a 128k"]).save(d).on("end",()=>b()).on("error",A=>v(A))}),p.track1=`clipvault://audio/${encodeURIComponent(`${e}_track1.m4a`)}`),!f&&x.length>=2&&(await new Promise((b,v)=>{ffmpeg(t).outputOptions(["-map 0:a:1","-c:a aac","-b:a 128k"]).save(o).on("end",()=>b()).on("error",A=>v(A))}),p.track2=`clipvault://audio/${encodeURIComponent(`${e}_track2.m4a`)}`),p}catch(i){return console.error("Failed to extract audio tracks:",i),{error:String(i)}}});electron.ipcMain.handle("editor:exportClip",async(n,e)=>{try{const{clipPath:t,exportFilename:i,trimStart:d,trimEnd:o,audioTrack1:p,audioTrack2:a,audioTrack1Volume:f,audioTrack2Volume:y,targetSizeMB:x="original"}=e,b=o-d,v=f??1,A=y??1,F=require$$1.join(clipsPath,"exported-clips");require$$0.existsSync(F)||await promises.mkdir(F,{recursive:!0});const E=require$$1.join(F,i);let g=null,C=!1;if(typeof x=="number"&&x>0&&b>0){const q=x*8192*.85,$=Math.floor(q/b);g=Math.max($-128,500),C=!0,console.log(`Target size: ${x}MB, Duration: ${b}s, Video bitrate: ${g}kbps`)}return new Promise((q,$)=>{const w=ffmpeg(t).seekInput(d).duration(b);if(C&&g?(w.videoCodec("libx264"),w.outputOptions(["-b:v",`${g}k`,"-maxrate",`${Math.floor(g*1.5)}k`,"-bufsize",`${g*2}k`,"-preset","fast","-crf","23","-pix_fmt","yuv420p"])):w.videoCodec("copy"),p&&a){const h=`[0:a:0]volume=${v}[a0];[0:a:1]volume=${A}[a1];[a0][a1]amix=inputs=2:duration=first:dropout_transition=3[aout]`;w.outputOptions(["-map 0:v:0","-filter_complex",h,"-map","[aout]","-c:a aac","-b:a 128k","-ac 2"])}else p?v<1?w.outputOptions(["-map 0:v:0","-map 0:a:0","-filter:a:0",`volume=${v}`]):w.outputOptions(["-map 0:v:0","-map 0:a:0"]):a?A<1?w.outputOptions(["-map 0:v:0","-map 0:a:1","-filter:a:0",`volume=${A}`]):w.outputOptions(["-map 0:v:0","-map 0:a:1"]):w.noAudio();w.on("progress",h=>{mainWindow&&h.percent&&mainWindow.webContents.send("export:progress",{percent:h.percent})}).on("end",()=>{q({success:!0,filePath:E})}).on("error",h=>{console.error("Export error:",h),$(h)}).save(E)})}catch(t){throw console.error("Failed to export clip:",t),t}});electron.app.whenReady().then(async()=>{console.log("App is ready, creating window..."),electron.protocol.registerFileProtocol("clipvault",(n,e)=>{try{console.log("Protocol handler called:",n.url);const t=new URL(n.url),i=t.host,d=t.pathname;if(console.log("Parsed URL:",{host:i,pathname:d}),!i||!d){console.error("Invalid URL format:",{host:i,pathname:d}),e({error:-2});return}const o=i,p=d.substring(1),a=decodeURIComponent(p);console.log("Processing file:",{type:o,filename:a});let f;if(o==="clip")f=clipsPath;else if(o==="thumb")f=thumbnailsPath;else if(o==="audio")f=require$$1.join(thumbnailsPath,"audio");else if(o==="exported")f=require$$1.join(clipsPath,"exported-clips");else{console.error("Unknown resource type:",o),e({error:-2});return}const y=require$$1.join(f,a);if(console.log("Full file path:",y),!require$$0.existsSync(y)){console.error("File not found:",y),e({error:-6});return}e({path:y})}catch(t){console.error("Protocol handler error:",t),e({error:-2})}}),createTray(),await createWindow().catch(n=>{console.error("Failed to create window:",n)}),console.log("Attempting to start backend..."),startBackend(),setTimeout(()=>{try{const{backendLogPath:n}=getBackendPaths(),t=require$$0$1.execSync('tasklist /NH /FO CSV /FI "IMAGENAME eq ClipVault.exe"',{encoding:"utf-8",stdio:["pipe","pipe","ignore"]}).includes("ClipVault.exe");console.log("Backend verification after spawn:",t?"running":"not running"),require$$0.existsSync(n)?console.log("Backend log file exists:",n):console.warn("Backend log file not found - spawn may have failed silently")}catch(n){console.log("Could not verify backend status:",n)}},2e3),electron.app.on("activate",()=>{electron.BrowserWindow.getAllWindows().length===0&&createWindow()})});electron.app.on("window-all-closed",()=>{process.platform!=="darwin"&&(tray||electron.app.quit())});electron.app.on("before-quit",n=>{console.log("App is quitting..."),isQuitting=!0,tray&&(tray.destroy(),tray=null)});electron.app.on("will-quit",()=>{isQuitting=!0});
//# sourceMappingURL=main.js.map
